<section class="lesson-material__content"><article class="material"><h1>Знакомство с flask-sqlalchemy</h1>
<section class="material__plan"><nav>
<ol>
<li><a class="material__link" href="#1">Базы данных и ORM</a></li>
<li><a class="material__link" href="#2">Установка</a></li>
<li><a class="material__link" href="#3">Постановка задачи для первого примера</a></li>
<li><a class="material__link" href="#4">Начальный каркас приложения</a></li>
<li><a class="material__link" href="#5">Таблица с пользователями</a></li>
<li><a class="material__link" href="#6">Таблица с новостями</a></li>
<li><a class="material__link" href="#7">Взаимодействие с базой данных</a></li>
<li><a class="material__link" href="#8">Небольшая шпаргалка по filter</a></li>
<li><a class="material__link" href="#9">Отображение публичных записей</a></li>
<li><a class="material__link" href="#10">Регистрация пользователей</a></li>
</ol>
</nav></section>
<section class="material__annotation">
<h2>Аннотация</h2>
<p>На этом и следующем занятиях мы создадим полноценное веб-приложение с регистрацией и авторизацией пользователей, работающее с базой данных через ORM.</p>
</section>
<section class="material__chapter">
<h2 id="1">Базы данных и ORM</h2>
<p>Мы уже достаточно тесно познакомились с реляционными базами данных: решали задачи с использованием БД, многие из вас уже использовали БД в своих проектах для хранения информации. Однако пока мы работали с данными исключительно с помощью запросов на языке SQL, которые составляли самостоятельно. Для небольших проектов это вполне оправдано и достаточно часто используется в реальной жизни. Flask «из коробки» не имеет собственных инструментов для работы с базами данных (в отличие, например, от Django) и предоставляет нам полную свободу выбора инструментов для работы.</p>
<p>Согласитесь: очень хочется перейти на более высокий уровень работы с данными. Представьте, что в вашем распоряжении есть объект, который связан с базой данных. Этот объект берет на себя всю работу по организации общения с данными. Вам лишь остается давать ему команды: получить данные, отфильтровать их по заданному условию, записать данные и т. д., а преобразование команд в SQL-запросы — это уже забота объекта. Работать с данными как с объектами чрезвычайно удобно — не зря же мы так много времени уделяем изучению объектного подхода.</p>
<p>К сожалению, написать универсальный модуль, который преобразовывает результат SQL-запроса в объекты и наоборот, достаточно нетривиальная задача. Хорошо, что она уже решена за нас.</p>
<p>В больших приложениях (не только для web) достаточно часто используется технология <a class="material__link" href="https://ru.wikipedia.org/wiki/ORM" rel="noopener noreferrer" target="_blank">ORM</a> (Object-Relational Mapping — объектно-реляционное отображение) — прослойка, позволяющая работать с базой данных через объекты языка. Кроме того, большинство ORM позволяют генерировать скрипты миграции базы данных для поддержания версионности (отдаленно можно сравнить c git, но для баз данных), а также предоставляют разработчику еще немало другой полезной функциональности. Мы будем использовать библиотеку sqlalchemy. Ее можно использовать не только при создании веб-приложений, но и при разработке любых программ, которые взаимодействуют с базами данных.</p>
</section>
<section class="material__chapter">
<h2 id="2">Установка</h2>
<p>Прежде чем мы начнем что-то делать, давайте установим sqlalchemy:</p>
<pre><code>pip install sqlalchemy
</code></pre>
</section>
<section class="material__chapter">
<h2 id="3">Постановка задачи для первого примера</h2>
<p>Давайте создадим веб-приложение, которое будет использовать базу данных и ORM для работы с ней. Для начала определимся с функциональностью.</p>
<p>У нас будет простое веб-приложение, в котором пользователи могут авторизовываться, просматривать, добавлять и удалять новости — такой мини-вариант личных блогов. Получается, нам надо хранить информацию о двух сущностях:</p>
<ol>
<li>Пользователи</li>
<li>Новости</li>
</ol>
<p>Причем каждая новость должна быть связана с автором новости, который ее написал.</p>
</section>
<section class="material__chapter">
<h2 id="4">Начальный каркас приложения</h2>
<p>Начнем создавать наше приложение с создания основного файла, который назовем main.py. Для начала разместим в нем уже привычный код:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>
app<span class="token punctuation">.</span>config<span class="token punctuation">[</span><span class="token string">'SECRET_KEY'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'yandexlyceum_secret_key'</span>


<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    main<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Создадим папки:</p>
<ul>
<li>db — для хранения одного единственного файла базы данных</li>
<li>data — для хранения классов, необходимых для взаимодействия с базой данных</li>
</ul>
<p>Внутри папки data создадим два файла, один назовем __all_models.py (в нем будем хранить модели для работы с базой данных), а — другой db_session.py — будет отвечать за подключение к базе данных и создание сессии для работы с ней.</p>
<p>Следующий шаг самый сложный. Не переживайте, этот код будет стандартным для всех ваших приложений и может переезжать от одного проекта к другому. Напишем в db_session.py вот такой код:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> sqlalchemy <span class="token keyword">as</span> sa
<span class="token keyword">import</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">as</span> orm
<span class="token keyword">from</span> sqlalchemy<span class="token punctuation">.</span>orm <span class="token keyword">import</span> Session
<span class="token keyword">import</span> sqlalchemy<span class="token punctuation">.</span>ext<span class="token punctuation">.</span>declarative <span class="token keyword">as</span> dec

SqlAlchemyBase <span class="token operator">=</span> dec<span class="token punctuation">.</span>declarative_base<span class="token punctuation">(</span><span class="token punctuation">)</span>

__factory <span class="token operator">=</span> <span class="token boolean">None</span>
</code></pre>
<p>Сначала импортируем необходимое — саму библиотеку sqlalchemy (в принципе, этого достаточно, остальные импорты нужны только для избавления от длинных путей), затем часть библиотеки, которая отвечает за функциональность ORM, потом объект <var>Session</var>, отвечающий за соединение с базой данных, и модуль declarative — он поможет нам объявить нашу базу данных.</p>
<p>Создадим две переменные: <var>SqlAlchemyBase</var> — некоторую абстрактную декларативную базу, в которую позднее будем наследовать все наши модели, и <var>__factory</var>, которую будем использовать для получения сессий подключения к нашей базе данных.</p>
<p>Кроме того, в файле db_session.py нам понадобится сделать еще две функции <var>global_init</var> и <var>create_session</var>.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">global_init</span><span class="token punctuation">(</span>db_file<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">global</span> __factory

    <span class="token keyword">if</span> __factory<span class="token punctuation">:</span>
        <span class="token keyword">return</span>

    <span class="token keyword">if</span> <span class="token keyword">not</span> db_file <span class="token keyword">or</span> <span class="token keyword">not</span> db_file<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">raise</span> Exception<span class="token punctuation">(</span><span class="token string">"Необходимо указать файл базы данных."</span><span class="token punctuation">)</span>

    conn_str <span class="token operator">=</span> <span class="token string-interpolation"><span class="token string">f'sqlite:///</span><span class="token interpolation"><span class="token punctuation">{</span>db_file<span class="token punctuation">.</span>strip<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">}</span></span><span class="token string">?check_same_thread=False'</span></span>
    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f"Подключение к базе данных по адресу </span><span class="token interpolation"><span class="token punctuation">{</span>conn_str<span class="token punctuation">}</span></span><span class="token string">"</span></span><span class="token punctuation">)</span>

    engine <span class="token operator">=</span> sa<span class="token punctuation">.</span>create_engine<span class="token punctuation">(</span>conn_str<span class="token punctuation">,</span> echo<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
    __factory <span class="token operator">=</span> orm<span class="token punctuation">.</span>sessionmaker<span class="token punctuation">(</span>bind<span class="token operator">=</span>engine<span class="token punctuation">)</span>

    <span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> __all_models

    SqlAlchemyBase<span class="token punctuation">.</span>metadata<span class="token punctuation">.</span>create_all<span class="token punctuation">(</span>engine<span class="token punctuation">)</span>
</code></pre>
<p><var>global_init</var> принимает на вход адрес базы данных, затем проверяет, не создали ли мы уже фабрику подключений (то есть не вызываем ли мы функцию не первый раз). Если уже создали, то завершаем работу, так как начальную инициализацию надо проводить только единожды.</p>
<p>Проверяем, что нам указали непустой адрес базы данных, а затем создаем строку подключения <var>conn_str</var> (она состоит из типа базы данных, адреса до базы данных и параметров подключения), которую передаем Sqlalchemy для того, чтобы она выбрала правильный движок работы с базой данных (переменная <var>engine</var>). В нашем случае это будет движок для работы с SQLite базами данных.</p>
<p>Если в функцию <code>create_engine()</code> передать параметр <var>echo</var> со значением True, в консоль будут выводиться все SQL-запросы, которые сделает SQLAlchemy, что очень удобно для отладки.</p>
<p>Наконец, создаем фабрику подключений к нашей базе данных, которая будет работать с нужным нам движком.</p>
<p>Импортируем все из файла __all_models.py — именно тут SQLalchemy узнает о всех наших моделях.</p>
<p>Наконец, заставляем нашу базу данных создать все объекты, которые она пока не создала. Обратите внимание: все таблицы, которые были уже созданы в базе данных, останутся без изменений.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">create_session</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">&gt;</span> Session<span class="token punctuation">:</span>
    <span class="token keyword">global</span> __factory
    <span class="token keyword">return</span> __factory<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Функция <var>create_session</var> нужна для получения сессии подключения к нашей базе данных. Часть <code>-&gt; Session</code> нужна лишь для того, чтобы явно указать PyCharm, что наша функция возвращает объект типа <code>sqlalchemy.orm.Session</code> и среда могла показывать нам подсказки далее.</p>
<p>В качестве завершающего штриха давайте добавим в main.py импорт содержимого файла db_session:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> data <span class="token keyword">import</span> db_session
</code></pre>
<p>И перед запуском приложения <code>app.run()</code> добавим вызов глобальной инициализации всего, что связано с базой данных:</p>
<pre class="language-python"><code class="language-python">db_session<span class="token punctuation">.</span>global_init<span class="token punctuation">(</span><span class="token string">"db/blogs.db"</span><span class="token punctuation">)</span>
</code></pre>
<p>В результате должна получиться примерно такая структура папок и файлов:</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/web/sqlalchemy-struct.png" width="680"/></div>
<p>Запустим наше приложение. Мы увидим, что оно работает и после запуска создало пустую базу данных по адресу db/blogs.db.</p>
<p>Теперь давайте создадим таблицы.</p>
</section>
<section class="material__chapter">
<h2 id="5">Таблица с пользователями</h2>
<p>Так как мы используем ORM, никакого SQL мы писать не будем и позволим sqlalchemy сделать всю работу за нас, а сами лишь опишем те классы, которые хотим получить для работы с базой в Python.</p>
<p>Давайте создадим в папке data файл users.py и опишем в нем класс <var>User</var> — модели для работы с таблицей, которая будет содержать информацию о пользователях нашего веб-приложения.</p>
<p>Подумаем, какая информация нам нужна о наших пользователях:</p>
<ol>
<li>Уникальный идентификатор пользователя — некоторый его номер в нашей базе данных, желательно, чтобы он генерировался автоматически без нашего участия.</li>
<li>Имя пользователя — некоторое строковое значение.</li>
<li>Описание пользователя — некоторая текстовая информация, которой пользователь хочет поделиться о себе.</li>
<li>Адрес электронной почты — уникальная строка (чтобы мы могли точно знать, для какого пользователя восстанавливать пароль). Так как мы достаточно часто будем искать пользователя по адресу электронной почты (как минимум, при логине), было бы здорово, если бы база могла как-то ускорить такой поиск.</li>
<li>Зашифрованный пароль пользователя — строка. <strong>Ни в коем случае нельзя хранить пароль пользователя в открытом виде!</strong></li>
<li>Дата создания пользователя — потому что нам хочется знать, когда пользователь зарегистрировался в нашем веб-приложении.</li>
</ol>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> datetime
<span class="token keyword">import</span> sqlalchemy
<span class="token keyword">from</span> <span class="token punctuation">.</span>db_session <span class="token keyword">import</span> SqlAlchemyBase


<span class="token keyword">class</span> <span class="token class-name">User</span><span class="token punctuation">(</span>SqlAlchemyBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'users'</span>

    <span class="token builtin">id</span> <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> 
                           primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>String<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    about <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>String<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    email <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>String<span class="token punctuation">,</span> 
                              index<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> unique<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    hashed_password <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>String<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    created_date <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> 
                                     default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
</code></pre>
<p>Чтобы обозначить, что <var>User</var> — не обычный класc, а именно класс модели, его необходимо унаследовать от объекта класса <var>SqlAlchemyBase</var>, который мы создали ранее.</p>
<p>В служебном атрибуте <var>__tablename__</var> указывается таблица, которая будет создана для хранения данных этой модели. Название таблицы можно не указывать, тогда sqlalchemy сделает таблицу сама, исходя из названия класса.</p>
<p>Для каждого из атрибутов типа <var>sqlalchemy.Column</var> будет создан одноименный столбец в базе данных согласно его описанию:</p>
<ul>
<li><code>sqlalchemy.Integer</code> (<code>sqlalchemy.String</code>, <code>sqlalchemy.DateTime</code> и т. д.) — указания типа данных</li>
<li><code>primary_key=True</code> — указание на то, что столбец является первичным ключом. Обычно первичный ключ — некоторый числовой идентификатор, который однозначно идентифицирует каждую запись в таблице</li>
<li><code>autoincrement=True</code> — признак автоинкрементного поля. Используется для увеличения значения первичного ключа на единицу при вставке каждой новой записи</li>
<li><code>nullable=True/False</code> — может ли поле не содержать никакой информации и быть пустым</li>
<li><code>unique=True/False</code> — содержит ли поле только уникальные значения или они могут повторяться</li>
<li><code>default=datetime.datetime.now</code> — значение по умолчанию. В данном случае мы говорим, что при вставке нового пользователя будет вставлена дата и время на момент его создания. Обратите внимание: мы не вызываем функцию, а передаем ее. Если бы мы вызвали функцию, то текущее время было бы вычислено только один раз при запуске сервера и было бы одинаковое для всех пользователей, которые были бы созданы после этого</li>
<li><code>index=True</code> — создать индекс по этому полю. <a class="material__link" href="https://ru.wikipedia.org/wiki/Индекс_(базы_данных)" rel="noopener noreferrer" target="_blank">Индекс</a>, если говорить упрощенно, позволяет значительно повысить скорость поиска по одному или нескольким полям базы данных. Цена этого — уменьшение скорости вставки данных, поэтому не стоит делать индексы на абсолютно все поля, а только на те (и ту их комбинацию), по которым будет часто осуществляться поиск</li>
</ul>
<p>Запустим наше приложение. Но почему ничего не произошло? Почему не создалась таблица?</p>
<p>На самом деле все просто. Наша база пока не знает про нашу модель. Давайте добавим информацию о ней в файл __all_models.py.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> users
</code></pre>
<p>Запустим еще раз.</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/web/sqlalchemy-1.png" width="388"/></div>
<p>Ура, все заработало!</p>
</section>
<section class="material__chapter">
<h2 id="6">Таблица с новостями</h2>
<p>По аналогии рядом с файлом users.py создадим файл news.py, а в нем — класс <var>News</var> для хранения следующей информации о новости:</p>
<ul>
<li>Уникальный идентификатор</li>
<li>Заголовок новости</li>
<li>Текст новости</li>
<li>Дата создания новости</li>
<li>Приватность новости (показывать ли ее всем или только автору)</li>
<li>Идентификатор автора новости</li>
</ul>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> datetime
<span class="token keyword">import</span> sqlalchemy
<span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> orm

<span class="token keyword">from</span> <span class="token punctuation">.</span>db_session <span class="token keyword">import</span> SqlAlchemyBase


<span class="token keyword">class</span> <span class="token class-name">News</span><span class="token punctuation">(</span>SqlAlchemyBase<span class="token punctuation">)</span><span class="token punctuation">:</span>
    __tablename__ <span class="token operator">=</span> <span class="token string">'news'</span>

    <span class="token builtin">id</span> <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> 
                           primary_key<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">,</span> autoincrement<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    title <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>String<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    content <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>String<span class="token punctuation">,</span> nullable<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
    created_date <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>DateTime<span class="token punctuation">,</span> 
                                     default<span class="token operator">=</span>datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">)</span>
    is_private <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>Boolean<span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>

    user_id <span class="token operator">=</span> sqlalchemy<span class="token punctuation">.</span>Column<span class="token punctuation">(</span>sqlalchemy<span class="token punctuation">.</span>Integer<span class="token punctuation">,</span> 
                                sqlalchemy<span class="token punctuation">.</span>ForeignKey<span class="token punctuation">(</span><span class="token string">"users.id"</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    user <span class="token operator">=</span> orm<span class="token punctuation">.</span>relation<span class="token punctuation">(</span><span class="token string">'User'</span><span class="token punctuation">)</span>
</code></pre>
<p>Здесь стоит обратить внимание на поля <var>user_id</var> и <var>user</var>.</p>
<p><var>user_id</var> — колонка, в которой указывается, что она ссылается на поле <var>id</var> таблицы <var>users</var>. А <var>user</var> — атрибут, который позволит нам получить для новости полноценный объект класса <var>User</var>.</p>
<p>Немного модифицируем наш класс с пользователями, добавим туда строчку:</p>
<pre class="language-python"><code class="language-python">news <span class="token operator">=</span> orm<span class="token punctuation">.</span>relation<span class="token punctuation">(</span><span class="token string">"News"</span><span class="token punctuation">,</span> back_populates<span class="token operator">=</span><span class="token string">'user'</span><span class="token punctuation">)</span>
</code></pre>
<p>И в блок импортов строчку:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> sqlalchemy <span class="token keyword">import</span> orm
</code></pre>
<p>Это позволит нам легко получать для пользователя все его новости. Обратите внимание: значение параметра <var>back_populates</var> должно указывать не на таблицу, а на атрибут класса <var>orm.relation</var>.</p>
<p>Чтобы подключить модель <var>News</var> к нашей базе данных, в файл __all_models.py надо добавить строку:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> <span class="token punctuation">.</span> <span class="token keyword">import</span> news
</code></pre>
<p>Удалим базу данных и запустим наше приложение заново, чтобы все таблицы пересоздались. Вот какие две таблицы у нас получились в базе данных:</p>
<div class="material__content-positioner"><img class="material__illustration" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/web/sqlalchemy-2.png" width="576"/></div>
</section>
<section class="material__chapter">
<h2 id="7">Взаимодействие с базой данных</h2>
<p>Давайте ненадолго сместим фокус от создания веб-приложения на взаимодействие с базой данных с помощью sqlalchemy.</p>
<p>Можно пока временно закомментировать строку <code>app.run()</code> в файле main.py.</p>
<p>Давайте напишем код, который создает пользователя в нашей базе данных.</p>
<p>Добавьте в секцию импортов строку</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> data<span class="token punctuation">.</span>users <span class="token keyword">import</span> User
</code></pre>
<p>чтобы можно было использовать класс <var>User</var>.</p>
<p>За добавление объектов отвечает метод <var>add</var> у объекта <var>session</var>.</p>
<pre class="language-python"><code class="language-python">user <span class="token operator">=</span> User<span class="token punctuation">(</span><span class="token punctuation">)</span>
user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Пользователь 1"</span>
user<span class="token punctuation">.</span>about <span class="token operator">=</span> <span class="token string">"биография пользователя 1"</span>
user<span class="token punctuation">.</span>email <span class="token operator">=</span> <span class="token string">"email@email.ru"</span>
db_sess <span class="token operator">=</span> db_session<span class="token punctuation">.</span>create_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Создадим еще нескольких пользователей, чтобы данные в таблице выглядели примерно вот так:</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/web/sqlalchemy-3.png" width="680"/></div>
<p>За получение данных отвечает метод <var>query</var> объекта <var>session</var>. В качестве параметра передаются классы объектов, которые мы хотим достать. Например, давайте достанем первого пользователя в выборке:</p>
<pre class="language-python"><code class="language-python">user <span class="token operator">=</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">.</span>name<span class="token punctuation">)</span>
</code></pre>
<pre><samp>Пользователь 1</samp></pre>
<p>А теперь пройдемся вообще по всем пользователям в таблице. Для более красивого представления переопределите метод <var>__repr__</var> у класса <var>User</var>:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">for</span> user <span class="token keyword">in</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">all</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre>
<pre><samp>&lt;User&gt; 1 Пользователь 1 email@email.ru
&lt;User&gt; 2 Пользователь 2 email2@email.ru
&lt;User&gt; 3 Пользователь 3 email1@email.ru</samp></pre>
<p>Метод <code>filter()</code> позволяет отфильтровать результаты с помощью оператора WHERE, примененного к запросу. Он принимает колонку, оператор или значение. Например, давайте отфильтруем пользователей и выберем только тех, у которых id &gt; 1, а почта не содержит 1.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">for</span> user <span class="token keyword">in</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">,</span> User<span class="token punctuation">.</span>email<span class="token punctuation">.</span>notilike<span class="token punctuation">(</span><span class="token string">"%1%"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre>
<pre><samp>&lt;User&gt; 2 Пользователь 2 email2@email.ru</samp></pre>
<p>Условия, перечисленные в скобках <var>filter</var> через запятую, соединяются в запросе через AND. Давайте изменим запрос, чтобы условия фильтра соединялись через OR:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">for</span> user <span class="token keyword">in</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">&gt;</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token punctuation">(</span>User<span class="token punctuation">.</span>email<span class="token punctuation">.</span>notilike<span class="token punctuation">(</span><span class="token string">"%1%"</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
</code></pre>
<p>Обратите внимание: в этом случае скобки вокруг частей фильтра <strong>обязательны</strong>.</p>
<p>Разумеется, sqlalchemy позволяет нам изменять и удалять записи в таблицах. Изменение записи сделать очень просто, надо выбрать нужную запись, поменять нужные атрибуты, а потом вызвать у сессии метод <var>commit</var>. Переименуем пользователя с id 1:</p>
<pre class="language-python"><code class="language-python">user <span class="token operator">=</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">print</span><span class="token punctuation">(</span>user<span class="token punctuation">)</span>
user<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">"Измененное имя пользователя"</span>
user<span class="token punctuation">.</span>created_date <span class="token operator">=</span> datetime<span class="token punctuation">.</span>datetime<span class="token punctuation">.</span>now<span class="token punctuation">(</span><span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/web/sqlalchemy-4.png" width="680"/></div>
<p>За удаление записей отвечает метод <code>delete()</code>.</p>
<p>Мы можем удалить как несколько записей по фильтру:</p>
<pre class="language-python"><code class="language-python">db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">&gt;=</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span>delete<span class="token punctuation">(</span><span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Так и какую-то уже заранее выбранную запись:</p>
<pre class="language-python"><code class="language-python">user <span class="token operator">=</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>delete<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>После всех изменений в базе данных не забывайте сделать <var>commit</var>.</p>
<p>После всех этих операций у нас должен остаться в базе всего один пользователь. Давайте добавим ему записи. Это можно сделать несколькими способами. Мы можем создать объект класса <var>News</var> и заполнить его поля, в том числе указать явно <var>id</var> записи автора:</p>
<pre class="language-python"><code class="language-python">news <span class="token operator">=</span> News<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">"Первая новость"</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">"Привет блог!"</span><span class="token punctuation">,</span> 
            user_id<span class="token operator">=</span><span class="token number">1</span><span class="token punctuation">,</span> is_private<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>add<span class="token punctuation">(</span>news<span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Можем в качестве <var>user</var> указать объект класса <var>User</var>, выбранный (или созданный) заранее:</p>
<pre class="language-python"><code class="language-python">user <span class="token operator">=</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
news <span class="token operator">=</span> News<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">"Вторая новость"</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">"Уже вторая запись!"</span><span class="token punctuation">,</span> 
            user<span class="token operator">=</span>user<span class="token punctuation">,</span> is_private<span class="token operator">=</span><span class="token boolean">False</span><span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>add<span class="token punctuation">(</span>news<span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>И самый удобный на наш взгляд вариант — использовать то, что через объект класса <var>User</var> мы можем взаимодействовать с его записями в таблице <var>News</var> почти как со списком:</p>
<pre class="language-python"><code class="language-python">user <span class="token operator">=</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span><span class="token builtin">id</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span>
news <span class="token operator">=</span> News<span class="token punctuation">(</span>title<span class="token operator">=</span><span class="token string">"Личная запись"</span><span class="token punctuation">,</span> content<span class="token operator">=</span><span class="token string">"Эта запись личная"</span><span class="token punctuation">,</span> 
            is_private<span class="token operator">=</span><span class="token boolean">True</span><span class="token punctuation">)</span>
user<span class="token punctuation">.</span>news<span class="token punctuation">.</span>append<span class="token punctuation">(</span>news<span class="token punctuation">)</span>
db_sess<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Так же легко мы можем обойти все новости конкретного пользователя:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">for</span> news <span class="token keyword">in</span> user<span class="token punctuation">.</span>news<span class="token punctuation">:</span>
    <span class="token keyword">print</span><span class="token punctuation">(</span>news<span class="token punctuation">)</span>
</code></pre>
<p>sqlalchemy — невероятно мощный и гибкий инструмент. Обязательно загляните в <a class="material__link" href="https://docs.sqlalchemy.org/en/13/" rel="noopener noreferrer" target="_blank">документацию</a>, потому что мы рассмотрели только самый минимум, необходимый для создания небольших веб-приложений и учебных проектов.</p>
</section>
<section class="material__chapter">
<h2 id="8">Небольшая шпаргалка по filter</h2>
<div class="material__content-positioner">
<table border="1" cellpadding="5px" style="border-collapse: collapse; width: 100%;">
<thead>
<tr>
<th>Операция</th>
<th>Синтаксис ORM</th>
</tr>
</thead>
<tbody>
<tr>
<td>EQUALS</td>
<td>query(User).filter(User.name == 'Иван')</td>
</tr>
<tr>
<td>NOT EQUAL</td>
<td>query(User).filter(User.name != 'Иван')</td>
</tr>
<tr>
<td>LIKE</td>
<td>query(User).filter(User.name.like('%Иван%'))</td>
</tr>
<tr>
<td>NOT LIKE</td>
<td>query(User).filter(User.name.notlike('%Иван%'))</td>
</tr>
<tr>
<td>IN</td>
<td>query(User).filter(User.name.in_(['Иван', 'Петр', 'Максим']))</td>
</tr>
<tr>
<td>NOT IN</td>
<td>query(User).filter(User.name.notin_(['Иван', 'Петр', 'Максим'])) или <br/>query(User).filter(~User.name.in_(['Иван', 'Петр', 'Максим']))</td>
</tr>
<tr>
<td>NULL</td>
<td>query(User).filter(User.name == None)</td>
</tr>
<tr>
<td>AND</td>
<td>query(User).filter(User.name == 'Иван', User.id &gt; 3) или query(User).filter(User.name == 'Иван').filter(User.id &gt; 3)</td>
</tr>
<tr>
<td>OR</td>
<td>query(User).filter((User.name == 'Иван') | (User.id &gt; 3)) или <br/>query(User).filter(or_(User.name == 'Иван', User.id &gt; 3))</td>
</tr>
</tbody>
</table>
</div>
</section>
<section class="material__chapter">
<h2 id="9">Отображение публичных записей</h2>
<p>Воспользуемся наработками прошлых уроков и создадим новый шаблон index.html на основе базового шаблона base.html, который мы делали на прошлом уроке. Скопируйте папку templates со всем ее содержимым из материалов, созданных на прошлом уроке, и отредактируйте файл index.html, чтобы он выглядел так:</p>
<pre class="language-python"><code class="language-python"><span class="token punctuation">{</span><span class="token operator">%</span> extends <span class="token string">"base.html"</span> <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token operator">%</span> block content <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Записи в блоге<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> item <span class="token keyword">in</span> news<span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col-md6 border rounded"</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>h2<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>title<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>h2<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>content<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>div<span class="token operator">&gt;</span>
        Автор <span class="token operator">-</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>user<span class="token punctuation">.</span>name<span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token punctuation">,</span> Дата написания <span class="token operator">-</span> <span class="token punctuation">{</span><span class="token punctuation">{</span>item<span class="token punctuation">.</span>created_date<span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">&gt;</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre>
<p>Обратите внимание: из каждой записи мы можем легко добраться до имени автора этой записи. А теперь добавим обработчик, чтобы при попадании на главную страницу нашего приложения все пользователи видели все публичные записи от всех авторов.</p>
<pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">"/"</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    db_sess <span class="token operator">=</span> db_session<span class="token punctuation">.</span>create_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
    news <span class="token operator">=</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>News<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>News<span class="token punctuation">.</span>is_private <span class="token operator">!=</span> <span class="token boolean">True</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">"index.html"</span><span class="token punctuation">,</span> news<span class="token operator">=</span>news<span class="token punctuation">)</span>
</code></pre>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/web/sqlalchemy-5.png" width="680"/></div>
</section>
<section class="material__chapter">
<h2 id="10">Регистрация пользователей</h2>
<p>Редко какое веб-приложение обходится без функциональности, доступной лишь зарегистрированным пользователям. Давайте добавим возможность пользователям регистрироваться в нашем приложении. Все классы для форм разместим в отдельном каталоге forms. Создадим в каталоге forms файл user.py, а в нем — класс, описывающий форму <var>RegisterForm</var>, в которую добавим все поля, которые будут в форме регистрации:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> flask_wtf <span class="token keyword">import</span> FlaskForm
<span class="token keyword">from</span> wtforms <span class="token keyword">import</span> PasswordField<span class="token punctuation">,</span> StringField<span class="token punctuation">,</span> TextAreaField<span class="token punctuation">,</span> SubmitField<span class="token punctuation">,</span> EmailField
<span class="token keyword">from</span> wtforms<span class="token punctuation">.</span>validators <span class="token keyword">import</span> DataRequired


<span class="token keyword">class</span> <span class="token class-name">RegisterForm</span><span class="token punctuation">(</span>FlaskForm<span class="token punctuation">)</span><span class="token punctuation">:</span>
    email <span class="token operator">=</span> EmailField<span class="token punctuation">(</span><span class="token string">'Почта'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    password <span class="token operator">=</span> PasswordField<span class="token punctuation">(</span><span class="token string">'Пароль'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    password_again <span class="token operator">=</span> PasswordField<span class="token punctuation">(</span><span class="token string">'Повторите пароль'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    name <span class="token operator">=</span> StringField<span class="token punctuation">(</span><span class="token string">'Имя пользователя'</span><span class="token punctuation">,</span> validators<span class="token operator">=</span><span class="token punctuation">[</span>DataRequired<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    about <span class="token operator">=</span> TextAreaField<span class="token punctuation">(</span><span class="token string">"Немного о себе"</span><span class="token punctuation">)</span>
    submit <span class="token operator">=</span> SubmitField<span class="token punctuation">(</span><span class="token string">'Войти'</span><span class="token punctuation">)</span>
</code></pre>
<p>Спросим пароль у пользователя несколько раз, чтобы убедиться, что он нигде не опечатался.</p>
<p>Теперь в папке templates создадим шаблон register.html для отображения нашей формы, он может выглядеть так:</p>
<pre class="language-python"><code class="language-python"><span class="token punctuation">{</span><span class="token operator">%</span> extends <span class="token string">"base.html"</span> <span class="token operator">%</span><span class="token punctuation">}</span>

<span class="token punctuation">{</span><span class="token operator">%</span> block content <span class="token operator">%</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span>h1<span class="token operator">&gt;</span>Регистрация<span class="token operator">&lt;</span><span class="token operator">/</span>h1<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>form action<span class="token operator">=</span><span class="token string">""</span> method<span class="token operator">=</span><span class="token string">"post"</span><span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>hidden_tag<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>email<span class="token punctuation">.</span>label <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>email<span class="token punctuation">(</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"email"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> error <span class="token keyword">in</span> form<span class="token punctuation">.</span>email<span class="token punctuation">.</span>errors <span class="token operator">%</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"alert alert-danger"</span> role<span class="token operator">=</span><span class="token string">"alert"</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span><span class="token punctuation">{</span> error <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>label <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>password<span class="token punctuation">(</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> error <span class="token keyword">in</span> form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>errors <span class="token operator">%</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"alert alert-danger"</span> role<span class="token operator">=</span><span class="token string">"alert"</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span><span class="token punctuation">{</span> error <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>password_again<span class="token punctuation">.</span>label <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>password_again<span class="token punctuation">(</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span><span class="token punctuation">,</span> <span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"password"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> error <span class="token keyword">in</span> form<span class="token punctuation">.</span>password_again<span class="token punctuation">.</span>errors <span class="token operator">%</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"alert alert-danger"</span> role<span class="token operator">=</span><span class="token string">"alert"</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span><span class="token punctuation">{</span> error <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>name<span class="token punctuation">.</span>label <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>name<span class="token punctuation">(</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> error <span class="token keyword">in</span> form<span class="token punctuation">.</span>name<span class="token punctuation">.</span>errors <span class="token operator">%</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"alert alert-danger"</span> role<span class="token operator">=</span><span class="token string">"alert"</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span><span class="token punctuation">{</span> error <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>about<span class="token punctuation">.</span>label <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>about<span class="token punctuation">(</span><span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"form-control"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span>br<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> <span class="token keyword">for</span> error <span class="token keyword">in</span> form<span class="token punctuation">.</span>about<span class="token punctuation">.</span>errors <span class="token operator">%</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span>p <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"alert alert-danger"</span> role<span class="token operator">=</span><span class="token string">"alert"</span><span class="token operator">&gt;</span>
                <span class="token punctuation">{</span><span class="token punctuation">{</span> error <span class="token punctuation">}</span><span class="token punctuation">}</span>
            <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
        <span class="token punctuation">{</span><span class="token operator">%</span> endfor <span class="token operator">%</span><span class="token punctuation">}</span>
    <span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span><span class="token punctuation">{</span><span class="token punctuation">{</span> form<span class="token punctuation">.</span>submit<span class="token punctuation">(</span><span class="token builtin">type</span><span class="token operator">=</span><span class="token string">"submit"</span><span class="token punctuation">,</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"btn btn-primary"</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">}</span><span class="token operator">&lt;</span><span class="token operator">/</span>p<span class="token operator">&gt;</span>
    <span class="token punctuation">{</span><span class="token punctuation">{</span>message<span class="token punctuation">}</span><span class="token punctuation">}</span>
<span class="token operator">&lt;</span><span class="token operator">/</span>form<span class="token operator">&gt;</span>
<span class="token punctuation">{</span><span class="token operator">%</span> endblock <span class="token operator">%</span><span class="token punctuation">}</span>
</code></pre>
<p>Прежде чем создавать обработчик URL, который будет отвечать за форму регистрации, давайте немного доработаем наш класс <var>User</var>. Как мы уже говорили, хранить пароль в открытом виде нельзя, поэтому во Flask есть инструменты, которые позволяют получить хешированное значение по строке и проверить, соответствует ли пароль хешу, который хранится в нашей базе данных. Функции <var>generate_password_hash</var> и <var>check_password_hash</var> хранятся в модуле werkzeug.security. Для большего удобства добавим в класс <var>User</var> две функции:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">set_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    self<span class="token punctuation">.</span>hashed_password <span class="token operator">=</span> generate_password_hash<span class="token punctuation">(</span>password<span class="token punctuation">)</span>

<span class="token keyword">def</span> <span class="token function">check_password</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">return</span> check_password_hash<span class="token punctuation">(</span>self<span class="token punctuation">.</span>hashed_password<span class="token punctuation">,</span> password<span class="token punctuation">)</span>
</code></pre>
<p>Первая устанавливает значение хэша пароля для переданной строки. А вторая проверяет, правильный ли пароль ввел пользователь. Одна понадобится нам для регистрации пользователя, а другая — позднее, когда мы будем делать авторизацию пользователей в нашем приложении.</p>
<p>А в раздел импортов добавим:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> werkzeug<span class="token punctuation">.</span>security <span class="token keyword">import</span> generate_password_hash<span class="token punctuation">,</span> check_password_hash
</code></pre>
<p>Добавим обработчик на адрес /register.</p>
<pre class="language-python"><code class="language-python"><span class="token decorator annotation punctuation">@app<span class="token punctuation">.</span>route</span><span class="token punctuation">(</span><span class="token string">'/register'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'GET'</span><span class="token punctuation">,</span> <span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">reqister</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    form <span class="token operator">=</span> RegisterForm<span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">if</span> form<span class="token punctuation">.</span>validate_on_submit<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data <span class="token operator">!=</span> form<span class="token punctuation">.</span>password_again<span class="token punctuation">.</span>data<span class="token punctuation">:</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Регистрация'</span><span class="token punctuation">,</span>
                                   form<span class="token operator">=</span>form<span class="token punctuation">,</span>
                                   message<span class="token operator">=</span><span class="token string">"Пароли не совпадают"</span><span class="token punctuation">)</span>
        db_sess <span class="token operator">=</span> db_session<span class="token punctuation">.</span>create_session<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">if</span> db_sess<span class="token punctuation">.</span>query<span class="token punctuation">(</span>User<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token builtin">filter</span><span class="token punctuation">(</span>User<span class="token punctuation">.</span>email <span class="token operator">==</span> form<span class="token punctuation">.</span>email<span class="token punctuation">.</span>data<span class="token punctuation">)</span><span class="token punctuation">.</span>first<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
            <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Регистрация'</span><span class="token punctuation">,</span>
                                   form<span class="token operator">=</span>form<span class="token punctuation">,</span>
                                   message<span class="token operator">=</span><span class="token string">"Такой пользователь уже есть"</span><span class="token punctuation">)</span>
        user <span class="token operator">=</span> User<span class="token punctuation">(</span>
            name<span class="token operator">=</span>form<span class="token punctuation">.</span>name<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
            email<span class="token operator">=</span>form<span class="token punctuation">.</span>email<span class="token punctuation">.</span>data<span class="token punctuation">,</span>
            about<span class="token operator">=</span>form<span class="token punctuation">.</span>about<span class="token punctuation">.</span>data
        <span class="token punctuation">)</span>
        user<span class="token punctuation">.</span>set_password<span class="token punctuation">(</span>form<span class="token punctuation">.</span>password<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
        db_sess<span class="token punctuation">.</span>add<span class="token punctuation">(</span>user<span class="token punctuation">)</span>
        db_sess<span class="token punctuation">.</span>commit<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token keyword">return</span> redirect<span class="token punctuation">(</span><span class="token string">'/login'</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> render_template<span class="token punctuation">(</span><span class="token string">'register.html'</span><span class="token punctuation">,</span> title<span class="token operator">=</span><span class="token string">'Регистрация'</span><span class="token punctuation">,</span> form<span class="token operator">=</span>form<span class="token punctuation">)</span>
</code></pre>
<p>Не забудьте импортировать форму:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> forms<span class="token punctuation">.</span>user <span class="token keyword">import</span> RegisterForm
</code></pre>
<p>После отправки формы на сервер проверяем, что пароли совпадают, а также что пользователя с таким адресом электронной почты пока нет в нашей базе данных.</p>
<p>Если все хорошо, добавляем пользователя в базу данных и отправляем его на страницу авторизации, которую сделаем на следующем уроке.</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/web/sqlalchemy-6.png" width="680"/></div>
<p>После добавления всех необходимых файлов в проект он должен выглядеть так:</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/web/sqlalchemy-proj.png" width="230"/></div>
<p><strong>Заключение.</strong></p>
<p>На этом уроке мы научились работать с ORM sqlalchemy и написали каркас нашего приложения, страницу отображения новостей, а также страницу регистрации пользователей. На следующем уроке мы сделаем авторизацию и ее проверку и поговорим еще о нескольких важных вещах.</p>
</section></article></section>