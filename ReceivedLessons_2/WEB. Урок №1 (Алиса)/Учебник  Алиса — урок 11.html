<section class="lesson-material__content"><article class="material"><h1>Алиса — урок 1</h1>
<section class="material__plan"><nav>
<ol>
<li><a class="material__link" href="#1">Алиса</a></li>
<li><a class="material__link" href="#2">Интеграция с Алисой</a></li>
<li><a class="material__link" href="#3">Логирование (журналирование)</a></li>
<li><a class="material__link" href="#4">Уровни логирования</a></li>
<li><a class="material__link" href="#5">Пишем код</a></li>
<li><a class="material__link" href="#6">Как работает данный код</a></li>
<li><a class="material__link" href="#7">Отладка с Postman</a></li>
<li><a class="material__link" href="#8">Регистрация и тестирование навыка</a></li>
<li><a class="material__link" href="#9">Именованные сущности</a></li>
<li><a class="material__link" href="#10">Ресурсы</a></li>
</ol>
</nav></section>
<section class="material__annotation">
<h2>Аннотация</h2>
<p>Мы начинаем блок по работе с голосовым помощником от Яндекса — Алисой.</p>
</section>
<section class="material__chapter">
<h2 id="1">Алиса</h2>
<p>Алиса — это голосовой помощник от Яндекса. Фактически, это робот, который умеет общаться с нами посредством компьютера или любого другого вычислительного устройства: мобильного телефона, часов, «умной колонки» и даже системы управления автомобилем. В процессе общения Алиса может отвечать на вопросы, искать информацию в Интернете, играть с нами в различные игры, торговать на бирже, информировать о погоде, распознавать образы, управлять компонентами «умного дома» и делать множество других вещей.</p>
<div class="material__content-positioner"><iframe allowfullscreen="allowfullscreen" frameborder="0" height="315" src="https://www.youtube.com/embed/mpa39xiuhw4" width="560"></iframe></div>
<p><strong>Навыками</strong> принято называть отдельные задачи, которые Алиса умеет решать. Например, программист может научить Алису заказывать пиццу. Это умение и будет навыком. Сейчас различными разработчиками создано <a class="material__link" href="https://dialogs.yandex.ru/store/" rel="noopener noreferrer" target="_blank">большое количество навыков</a>, мы же с вами сегодня сделаем простой навык под названием «Купи слона», в котором Алиса будет с нами играть в простую игру:</p>
<ul>
<li>Купи слона</li>
<li>Нет</li>
<li>Все говорят «Нет». А ты купи слона</li>
<li>Хорошо</li>
<li>Слона можно найти на Яндекс.Маркете!</li>
</ul>
<p>И на этом все. Эта игра — пример, который приведен на официальном сайте платформы Яндекс.Диалоги — места, где любой человек может публиковать свои навыки для Алисы.</p>
<p>Но для начала работы узнаем несколько вещей о разработке навыков.</p>
</section>
<section class="material__chapter">
<h2 id="2">Интеграция с Алисой</h2>
<p>Первое, в чем нужно разобраться — как интегрироваться с Алисой. Алиса не имеет API в классическом понимании — как, например, у Яндекс.Карт. Интеграция происходит по технологии WebHook (технология — это громкое слово, скорее, идея).</p>
<p>Почему Алиса просто не могла предоставить нам API для работы? Как вы думаете, в чем сложность?</p>
<p>Алиса может обратиться к нашему навыку в любое время, поскольку никто не знает, когда один из миллионов пользователей Алисы решит им воспользоваться. Если бы Алиса предоставляла свое API, мы должны были бы регулярно ее спрашивать: «Эй, Алиса, никто не запрашивал наш навык?», затем при положительном ответе: «Запрашивали? Вот мой ответ. А что там ответил пользователь?» и так далее.</p>
<p>Как же быть?</p>
<p>Оказывается, лучшим решением является такое, в котором Алиса сама сообщит нам обо всех событиях, которые нас касаются. Идея WebHook’ов состоит в том, что мы не обращаемся к API, а реализуем свое, но по правилам, описанным в документации. Даем доступ к созданному API Алисе, и уже она начинает общаться с ним самостоятельно. Получается как бы «интеграция наоборот». В документации Алисы есть строгие требования к нашему API. После того, как API реализован, мы «говорим» Алисе, куда обращаться: сообщаем наш адрес. Если в интерфейсе Алисы кто-то вызвал наш навык, то Алиса сама нам об этом сообщит. Очень удобно! Не надо постоянно «пинать» Алису.</p>
</section>
<section class="material__chapter">
<h2 id="3">Логирование (журналирование)</h2>
<p>Представьте ситуацию: вы не можете видеть на мониторе работу вашей программы. У вас просто может не быть монитора. Или программа размещена не на вашем компьютере, а где-то в облаке. И вы понимаете, что программа работает некорректно. Как же узнать, как она работает, и где вкралась ошибка? В таком случае помогает логирование.</p>
<section class="material__note">
<p class="material__note-heading"><strong>Логирование</strong></p>
<p>Логирование — это запись и вывод информации о выполняемых операциях, ошибках и других событиях в коде. Это могут быть значения переменных или любой текст.</p>
</section>
<p>Логирование может происходить в консоль или файл. Логи выводятся в консоль, например, в процессе отладки приложения. Если вы уже написали программу, которая выполняется на сервере, то записывать логи желательно в файл, чтобы потом их можно было изучить в случае остановки, падения или перезагрузки сервера.</p>
<p>Для логирования в Python используется библиотека logging.</p>
<p>Пример:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> logging


<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        i <span class="token operator">+=</span> <span class="token number">1</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    log<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Выводит в консоль:</p>
<pre><samp>WARNING:root:0
WARNING:root:1
WARNING:root:2
WARNING:root:3
WARNING:root:4
WARNING:root:5
WARNING:root:6
WARNING:root:7
WARNING:root:8
WARNING:root:9</samp></pre>
<p>В этом примере мы используем библиотеку logging с параметрами по умолчанию, поэтому вся информация выводится в консоль. Мы использовали функцию <code>warning()</code>, которая предназначена для привлечения внимания к проблеме, которая еще не считается ошибкой. <var>root</var> — это имя журнала, его можно менять.</p>
<p>Давайте научимся сохранять данные журнала в файл. Еще раз напомним, что это — правильная практика, когда программа используется в боевом режиме (production), так как файл сохранится в случае остановки, падения или перезагрузки сервера.</p>
<p>Для логирования в файл нужно добавить в код следующую строку:</p>
<pre class="language-python"><code class="language-python">logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span><span class="token string">'example.log'</span><span class="token punctuation">)</span>
</code></pre>
<p>Теперь код целиком выглядит так:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>filename<span class="token operator">=</span><span class="token string">'example.log'</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">log_to_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        i <span class="token operator">+=</span> <span class="token number">1</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    log_to_file<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>После того, как мы запустим программу, в папке программы создастся файл example.log, и в нем окажется та же информация, что ранее выводилась в консоль:</p>
<pre><samp>WARNING:root:0
WARNING:root:1
WARNING:root:2
WARNING:root:3
WARNING:root:4
WARNING:root:5
WARNING:root:6
WARNING:root:7
WARNING:root:8
WARNING:root:9</samp></pre>
<p>Если мы запустим программу повторно, то увидим, что старые данные из файла не удаляются. Таким образом, информация будет записана дважды.</p>
<p>Чего же не хватает в файле? Что еще нам важно знать? Правильно — время события, ведь без него никакого расследования не получится.</p>
<p>Для того чтобы вывести временную метку, надо в функцию <code>logging.basicConfig()</code> передать еще один параметр — <var>format</var>. Как несложно догадаться, это формат сообщения (как выглядит и что содержит), которое записывается в лог. Сообщение в логе может содержать много полезной информации (подробно можно изучить <a class="material__link" href="https://docs.python.org/3/library/logging.html#logrecord-attributes" rel="noopener noreferrer" target="_blank">тут</a>). Мы рассмотрим только четыре атрибута, которые можно вывести, и подробно расскажем о них.</p>
<p>С добавлением параметра <var>format</var> наш код будет выглядеть так:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>
    filename<span class="token operator">=</span><span class="token string">'example.log'</span><span class="token punctuation">,</span>
    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s %(name)s %(message)s'</span>
<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">log_to_file</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    i <span class="token operator">=</span> <span class="token number">0</span>
    <span class="token keyword">while</span> i <span class="token operator">&lt;</span> <span class="token number">10</span><span class="token punctuation">:</span>
        logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span>i<span class="token punctuation">)</span>
        i <span class="token operator">+=</span> <span class="token number">1</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    log_to_file<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Рассмотрим параметр <code>format='%(asctime)s %(levelname)s %(name)s %(message)s'</code>.</p>
<p>Здесь:</p>
<div class="material__content-positioner">
<table border="1" cellpadding="5px" style="border-collapse: collapse; width: 100%;">
<tbody>
<tr>
<td><strong>asctime</strong></td>
<td>Время события</td>
</tr>
<tr>
<td><strong>levelname</strong></td>
<td>Уровень логирования (подробно об этом расскажем ниже)</td>
</tr>
<tr>
<td><strong>name</strong></td>
<td>Имя логера (журнала). По умолчанию — root, но вы можете задавать разные имена, чтобы сделать свои логи более информативными. Например, считается хорошей практикой назначать имя файла с кодом</td>
</tr>
<tr>
<td><strong>message</strong></td>
<td>Сообщение, которое вы отправили в <code>logging.warning()</code></td>
</tr>
</tbody>
</table>
</div>
<p>После запуска мы увидим в файле:</p>
<pre><samp>2018-12-23 21:08:58,805 WARNING root 0
2018-12-23 21:08:58,805 WARNING root 1
2018-12-23 21:08:58,805 WARNING root 2
2018-12-23 21:08:58,805 WARNING root 3
2018-12-23 21:08:58,805 WARNING root 4
2018-12-23 21:08:58,806 WARNING root 5
2018-12-23 21:08:58,806 WARNING root 6
2018-12-23 21:08:58,806 WARNING root 7
2018-12-23 21:08:58,806 WARNING root 8
2018-12-23 21:08:58,806 WARNING root 9</samp></pre>
</section>
<section class="material__chapter">
<h2 id="4">Уровни логирования</h2>
<p>Запись в логи принято разбирать на типы — уровни. Любое сообщение несет в себе информацию определенной важности, и время реакции на сообщения отличается. Приведем примеры:</p>
<div class="material__content-positioner">
<table border="1" cellpadding="5px" style="border-collapse: collapse; width: 100%;">
<tbody>
<tr>
<td><strong>Уровень</strong></td>
<td><strong>Пример события</strong></td>
</tr>
<tr>
<td><strong>Debug</strong></td>
<td>Отправлен запрос в базу данных на сохранение</td>
</tr>
<tr>
<td><strong>Debug</strong></td>
<td>Завершен запрос в базу данных на сохранение</td>
</tr>
<tr>
<td><strong>Debug</strong></td>
<td>Запрос в базу занял 0.02 секунды, извлечено 1000 записей</td>
</tr>
<tr>
<td><strong>Info</strong></td>
<td>Зарегистрирован новый пользователь (user_id = 123123)</td>
</tr>
<tr>
<td><strong>Warning</strong></td>
<td>Отклонена транзакция с суммой платежа 0</td>
</tr>
<tr>
<td><strong>Error</strong></td>
<td>Ошибка при сохранении данных пользователя (user_id = 123124, operation_id = 12312313)</td>
</tr>
<tr>
<td><strong>Critical (Fatal)</strong></td>
<td>Ошибка ответа API Яндекс Карт, код: 404. Маршруты не рассчитываются</td>
</tr>
</tbody>
</table>
</div>
<p>Начинающему программисту бывает сложно определить, к какому уровню следует отнести то или иное событие, возникающее при работе программы. Мы приведем базовые принципы, однако надо иметь в виду, что правила всегда определяет руководитель команды, которая работает над проектом.</p>
<div class="material__content-positioner">
<table border="1" cellpadding="5px" style="border-collapse: collapse; width: 100%;">
<tbody>
<tr>
<td><strong>Уровень</strong></td>
<td><strong>Относящиеся события</strong></td>
</tr>
<tr>
<td><strong>Debug</strong></td>
<td>Сообщения отладки. В боевом режиме (production) сообщения этого уровня обычно отключены, чтобы не засорять файлы журналов. Но они могут включаться для поиска багов, которые не удалось воспроизвести</td>
</tr>
<tr>
<td><strong>Info</strong></td>
<td>Обычные сообщения, информирующие о действиях программы. Реагировать на такие сообщения вообще не надо, но они могут помочь, например, при поиске багов, расследовании интересных ситуаций и т. д.</td>
</tr>
<tr>
<td><strong>Warning</strong></td>
<td>Записывая такое сообщение, программа обычно пытается привлечь внимание. Произошло что-то странное. Возможно, это новый тип ситуации, еще не известный на текущий момент. Следует разобраться в том, что произошло, что это означает, и отнести ситуацию либо к инфо-сообщению, либо к ошибке. Соответственно, придется доработать код обработки таких ситуаций</td>
</tr>
<tr>
<td><strong>Error</strong></td>
<td>Ошибка в работе программы, требующая вмешательства. Что-то не сохранилось, что-то отвалилось. Необходимо принимать меры довольно быстро! Ошибки этого уровня и выше требуют немедленной записи в лог, чтобы ускорить реакцию на них</td>
</tr>
<tr>
<td><strong>Critical (Fatal)</strong></td>
<td>Это — особый класс ошибок, приводящих к неработоспособности программы в целом или неработоспособности одного из ее модулей. Чаще всего случаются фатальные ошибки из-за неверной конфигурации или отказов оборудования. Требуют срочной, немедленной реакции</td>
</tr>
</tbody>
</table>
</div>
<p>Имейте в виду, что это — рекомендации. Вы как архитектор программы вправе определять критичность события или ошибки в своей программе, а если работа происходит в команде, то решение о критичности той или иной ситуации принимается руководителем команды или коллегиально.</p>
<p>Разработчик может настраивать уровень логирования. Логируются сообщения установленного уровня и уровней более высокой критичности. Например, если установлен уровень Info, то в консоль или в файл будут выводиться сообщения уровней: Info, Warning, Error и Fatal.</p>
<p>Уровень логирования по умолчанию — WARNING.</p>
<div class="material__content-positioner"><img class="material__illustration" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/logging-levels.svg" width="680"/></div>
<p>Уровень логирования в Python настраивается все в той же функции <code>logging.basicConfig()</code> следующим образом:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> logging

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>DEBUG<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">log</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>

    logging<span class="token punctuation">.</span>debug<span class="token punctuation">(</span><span class="token string">'Debug'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Info'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>warning<span class="token punctuation">(</span><span class="token string">'Warning'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>error<span class="token punctuation">(</span><span class="token string">'Error'</span><span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>critical<span class="token punctuation">(</span><span class="token string">'Critical or Fatal'</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    log<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Видим в консоли:</p>
<pre><samp>DEBUG:root:Debug
INFO:root:Info
WARNING:root:Warning
ERROR:root:Error
CRITICAL:root:Critical or Fatal</samp></pre>
<p>Если вызвать <code>logging.basicConfig(level=logging.ERROR)</code>, в консоли мы увидим:</p>
<pre><samp>ERROR:root:Error
CRITICAL:root:Critical or Fatal</samp></pre>
<p>Используйте логирование в процессе разработки. Это поможет вам правильно и своевременно реагировать на ошибки, искать баги и понимать, что происходит в вашей программе в любой момент времени.</p>
</section>
<section class="material__chapter">
<h2 id="5">Пишем код</h2>
<p>Теперь переходим к самому интересному. Начнем! Мы разработаем навык, который описан в разделе <a class="material__link" href="https://tech.yandex.ru/dialogs/alice/doc/quickstart-python-docpage/" rel="noopener noreferrer" target="_blank">«Быстрый старт»</a> документации Алисы.</p>
<p>Вы уже знакомы с библиотекой Flask. С ее помощью мы напишем небольшой веб-сервер, который будет обрабатывать запросы от Алисы.</p>
<p>Алиса будет передавать нам JSON, содержащий данные о пользователе, и информацию, которую пользователь ввел. Мы же должны будем вернуть в ответ свой JSON (соответственно документации). Алиса его обработает и покажет пользователю.</p>
<p>Рассмотрим JSON запроса, который отправит нам Алиса. На самом деле JSON выглядит сложнее и имеет больше полей, но мы рассмотрим только те из них, которые будем использовать (внимательно изучить содержание JSON’ов можно в <a class="material__link" href="https://yandex.ru/dev/dialogs/alice/doc/protocol-docpage/" rel="noopener noreferrer" target="_blank">документации</a>):</p>
<pre class="language-python"><code class="language-python"><span class="token punctuation">{</span>
  <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"закажи пиццу на улицу льва толстого, 16 на завтра"</span><span class="token punctuation">,</span>
    <span class="token string">"original_utterance"</span><span class="token punctuation">:</span> <span class="token string">"закажи пиццу на улицу льва толстого, 16 на завтра"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"session"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"new"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>
    <span class="token string">"message_id"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token string">"session_id"</span><span class="token punctuation">:</span> <span class="token string">"2eac4854-fce721f3-b845abba-20d60"</span><span class="token punctuation">,</span>
    <span class="token string">"skill_id"</span><span class="token punctuation">:</span> <span class="token string">"3ad36498-f5rd-4079-a14b-788652932056"</span><span class="token punctuation">,</span>
    <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"AC9WC3DF6FCE052E45A4566A48E6B7193774B84814CE49A922E163B8B29881DC"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0"</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li><var>request</var> — данные, полученные от пользователя
<ul>
<li><var>command</var> — запрос, который был передан вместе с командой активации навыка. Например, если пользователь активирует навык словами «спроси у Сбербанка, где ближайшее отделение», в этом поле будет передана строка «где ближайшее отделение»</li>
<li><var>original_utterance</var> — полный текст пользовательского запроса, максимум 1024 символа</li>
</ul>
</li>
<li><var>session</var> — данные о сессии (разговоре с Алисой)
<ul>
<li><var>new</var> — признак новой сессии. Возможные значения: true — пользователь начинает новый разговор с навыком, false — запрос отправлен в рамках уже начатого разговора</li>
<li><var>message_id</var> — идентификатор сообщения в рамках сессии, максимум 8 символов. Инкрементируется (увеличивается на единицу) с каждым следующим запросом</li>
<li><var>session_id</var> — уникальный идентификатор сессии, максимум 64 символа</li>
<li><var>skill_id</var> — идентификатор вызываемого навыка, присвоенный при создании</li>
<li><var>user_id</var> — идентификатор экземпляра приложения, в котором пользователь общается с Алисой, максимум 64 символа. Даже если пользователь авторизован с одним и тем же аккаунтом в приложении Яндекс для Android и iOS, Яндекс.Диалоги (так называется сервис Яндекса, управляющий навыками для Алисы) присвоят отдельный <var>user_id</var> каждому из этих приложений</li>
</ul>
</li>
<li><var>version</var> — версия протокола. Текущая версия — 1.0</li>
</ul>
<p>JSON ответа Алисы (то есть тот JSON, что сформирует наша программа) будет выглядеть так (конечно же, полное описание можно посмотреть в <a class="material__link" href="https://tech.yandex.ru/dialogs/alice/doc/protocol-docpage/" rel="noopener noreferrer" target="_blank">документации</a>):</p>
<pre class="language-python"><code class="language-python"><span class="token punctuation">{</span>
  <span class="token string">"response"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"Здравствуйте! Это мы, хороводоведы."</span><span class="token punctuation">,</span>
    <span class="token string">"tts"</span><span class="token punctuation">:</span> <span class="token string">"Здравствуйте! Это мы, хоров+одо в+еды."</span><span class="token punctuation">,</span>
    <span class="token string">"buttons"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Надпись на кнопке"</span><span class="token punctuation">,</span>
            <span class="token string">"payload"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://example.com/"</span><span class="token punctuation">,</span>
            <span class="token string">"hide"</span><span class="token punctuation">:</span> true
        <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"end_session"</span><span class="token punctuation">:</span> false
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"session"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"session_id"</span><span class="token punctuation">:</span> <span class="token string">"2eac4854-fce721f3-b845abba-20d60"</span><span class="token punctuation">,</span>
    <span class="token string">"message_id"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"AC9WC3DF6FCE052E45A4566A48E6B7193774B84814CE49A922E163B8B29881DC"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0"</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li><var>response</var> — данные для ответа пользователю
<ul>
<li><var>text</var> — текст, который следует показать. Максимум 1024 символа. Не должен быть пустым</li>
<li><var>tts</var> — текст, который следует сказать пользователю. Максимум 1024 символа. Не должен быть пустым</li>
<li><var>buttons</var> — массив кнопок, которые следует показать пользователю. Все указанные кнопки выводятся после основного ответа Алисы, описанного в свойстве <var>text</var>. Кнопки можно использовать как релевантные ответу ссылки или подсказки для продолжения разговора</li>
<li><var>title</var> — текст кнопки, обязателен для каждой кнопки. Максимум 64 символа</li>
<li><var>url</var> — URL, который должна открывать кнопка, максимум 1024 байта</li>
<li><var>payload</var> — значения, которые передадутся в программу после нажатия этой кнопки</li>
<li><var>hide</var> — признак того, что кнопку нужно убрать после следующей реплики пользователя. Допустимые значения: false — кнопка должна оставаться активной (значение по умолчанию), true — кнопку нужно скрывать после нажатия</li>
<li><var>end_session</var> — признак конца разговора. Допустимые значения: false — сессию следует продолжить, true — сессию следует завершить</li>
</ul>
</li>
<li><var>session</var> — данные о сессии (аналогичные запросу)</li>
<li><var>version</var> — версия протокола. Текущая версия — 1.0</li>
</ul>
<p>Вы можете скачать <a class="material__link" href="https://yastatic.net/s3/lyceum/content/resources/flask_app.py" rel="noopener noreferrer" target="_blank">файл с шаблоном кода</a> или скопировать текст программы ниже.</p>
<pre class="language-python"><code class="language-python"><span class="token comment"># импортируем библиотеки</span>
<span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
<span class="token keyword">import</span> logging

<span class="token comment"># библиотека, которая нам понадобится для работы с JSON</span>
<span class="token keyword">import</span> json

<span class="token comment"># создаём приложение</span>
<span class="token comment"># мы передаём __name__, в нем содержится информация, </span>
<span class="token comment"># в каком модуле мы находимся.</span>
<span class="token comment"># В данном случае там содержится '__main__', </span>
<span class="token comment"># так как мы обращаемся к переменной из запущенного модуля.</span>
<span class="token comment"># если бы такое обращение, например, </span>
<span class="token comment"># произошло внутри модуля logging, то мы бы получили 'logging'</span>
app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># Устанавливаем уровень логирования</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

<span class="token comment"># Создадим словарь, чтобы для каждой сессии общения </span>
<span class="token comment"># с навыком хранились подсказки, которые видел пользователь.</span>
<span class="token comment"># Это поможет нам немного разнообразить подсказки ответов </span>
<span class="token comment"># (buttons в JSON ответа).</span>
<span class="token comment"># Когда новый пользователь напишет нашему навыку, </span>
<span class="token comment"># то мы сохраним в этот словарь запись формата</span>
<span class="token comment"># sessionStorage[user_id] = {'suggests': ["Не хочу.", "Не буду.", "Отстань!" ]}</span>
<span class="token comment"># Такая запись говорит, что мы показали пользователю эти три подсказки. </span>
<span class="token comment"># Когда он откажется купить слона,</span>
<span class="token comment"># то мы уберем одну подсказку. Как будто что-то меняется :)</span>
sessionStorage <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>


@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token comment"># Функция получает тело запроса и возвращает ответ.</span>
<span class="token comment"># Внутри функции доступен request.json - это JSON, </span>
<span class="token comment"># который отправила нам Алиса в запросе POST</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Request: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>json<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    <span class="token comment"># Начинаем формировать ответ, согласно документации</span>
    <span class="token comment"># мы собираем словарь, который потом при помощи </span>
    <span class="token comment"># библиотеки json преобразуем в JSON и отдадим Алисе</span>
    response <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'session'</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'version'</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'version'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'response'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'end_session'</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment"># Отправляем request.json и response в функцию handle_dialog. </span>
    <span class="token comment"># Она сформирует оставшиеся поля JSON, которые отвечают</span>
    <span class="token comment"># непосредственно за ведение диалога</span>
    handle_dialog<span class="token punctuation">(</span>request<span class="token punctuation">.</span>json<span class="token punctuation">,</span> response<span class="token punctuation">)</span>

    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Response:  </span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>

    <span class="token comment"># Преобразовываем в JSON и возвращаем</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>response<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">handle_dialog</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_id <span class="token operator">=</span> req<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span>

    <span class="token keyword">if</span> req<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># Это новый пользователь.</span>
        <span class="token comment"># Инициализируем сессию и поприветствуем его.</span>
        <span class="token comment"># Запишем подсказки, которые мы ему покажем в первый раз</span>

        sessionStorage<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'suggests'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
                <span class="token string">"Не хочу."</span><span class="token punctuation">,</span>
                <span class="token string">"Не буду."</span><span class="token punctuation">,</span>
                <span class="token string">"Отстань!"</span><span class="token punctuation">,</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span>
        <span class="token comment"># Заполняем текст ответа</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Привет! Купи слона!'</span>
        <span class="token comment"># Получим подсказки</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'buttons'</span><span class="token punctuation">]</span> <span class="token operator">=</span> get_suggests<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>
        <span class="token keyword">return</span>

    <span class="token comment"># Сюда дойдем только, если пользователь не новый, </span>
    <span class="token comment"># и разговор с Алисой уже был начат</span>
    <span class="token comment"># Обрабатываем ответ пользователя.</span>
    <span class="token comment"># В req['request']['original_utterance'] лежит весь текст,</span>
    <span class="token comment"># что нам прислал пользователь</span>
    <span class="token comment"># Если он написал 'ладно', 'куплю', 'покупаю', 'хорошо', </span>
    <span class="token comment"># то мы считаем, что пользователь согласился.</span>
    <span class="token comment"># Подумайте, всё ли в этом фрагменте написано "красиво"?</span>
    <span class="token keyword">if</span> req<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'original_utterance'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">in</span> <span class="token punctuation">[</span>
        <span class="token string">'ладно'</span><span class="token punctuation">,</span>
        <span class="token string">'куплю'</span><span class="token punctuation">,</span>
        <span class="token string">'покупаю'</span><span class="token punctuation">,</span>
        <span class="token string">'хорошо'</span>
    <span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># Пользователь согласился, прощаемся.</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Слона можно найти на Яндекс.Маркете!'</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'end_session'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">True</span>
        <span class="token keyword">return</span>

    <span class="token comment"># Если нет, то убеждаем его купить слона!</span>
    res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> \
        <span class="token string-interpolation"><span class="token string">f"Все говорят '</span><span class="token interpolation"><span class="token punctuation">{</span>req<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'original_utterance'</span><span class="token punctuation">]</span><span class="token punctuation">}</span></span><span class="token string">', а ты купи слона!"</span></span>
    res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'buttons'</span><span class="token punctuation">]</span> <span class="token operator">=</span> get_suggests<span class="token punctuation">(</span>user_id<span class="token punctuation">)</span>


<span class="token comment"># Функция возвращает две подсказки для ответа.</span>
<span class="token keyword">def</span> <span class="token function">get_suggests</span><span class="token punctuation">(</span>user_id<span class="token punctuation">)</span><span class="token punctuation">:</span>
    session <span class="token operator">=</span> sessionStorage<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span>

    <span class="token comment"># Выбираем две первые подсказки из массива.</span>
    suggests <span class="token operator">=</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span><span class="token string">'title'</span><span class="token punctuation">:</span> suggest<span class="token punctuation">,</span> <span class="token string">'hide'</span><span class="token punctuation">:</span> <span class="token boolean">True</span><span class="token punctuation">}</span>
        <span class="token keyword">for</span> suggest <span class="token keyword">in</span> session<span class="token punctuation">[</span><span class="token string">'suggests'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token punctuation">:</span><span class="token number">2</span><span class="token punctuation">]</span>
    <span class="token punctuation">]</span>

    <span class="token comment"># Убираем первую подсказку, чтобы подсказки менялись каждый раз.</span>
    session<span class="token punctuation">[</span><span class="token string">'suggests'</span><span class="token punctuation">]</span> <span class="token operator">=</span> session<span class="token punctuation">[</span><span class="token string">'suggests'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token punctuation">]</span>
    sessionStorage<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> session

    <span class="token comment"># Если осталась только одна подсказка, предлагаем подсказку</span>
    <span class="token comment"># со ссылкой на Яндекс.Маркет.</span>
    <span class="token keyword">if</span> <span class="token builtin">len</span><span class="token punctuation">(</span>suggests<span class="token punctuation">)</span> <span class="token operator">&lt;</span> <span class="token number">2</span><span class="token punctuation">:</span>
        suggests<span class="token punctuation">.</span>append<span class="token punctuation">(</span><span class="token punctuation">{</span>
            <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Ладно"</span><span class="token punctuation">,</span>
            <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://market.yandex.ru/search?text=слон"</span><span class="token punctuation">,</span>
            <span class="token string">"hide"</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>

    <span class="token keyword">return</span> suggests


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Сохраните ваш файл под именем flask_app.py.</p>
</section>
<section class="material__chapter">
<h2 id="6">Как работает данный код</h2>
<p>Разберем тезисно, как работает приведенная программа.</p>
<ol>
<li>Когда мы запускаем программу, точкой входа в нее со стороны Алисы является функция <code>main()</code>, которая «обернута» декоратором <var>app.route</var>.</li>
<li>Внутри <code>main()</code> мы сначала логируем полученный запрос, затем начинаем формировать ответ, потом вызываем функцию <code>handle_dialog()</code> для обработки диалога с пользователем, в результате же логируем и возвращаем ответ.</li>
<li>Функция <code>handle_dialog()</code> формирует ответ, исходя из данных запроса и состояния сессии (новый разговор или продолжение старого).</li>
<li>Вспомогательная функция <code>get_suggests()</code> формирует подсказки в ответе.</li>
<li>В глобальном словаре <var>sessionStorage</var> мы будем хранить информацию о подсказках для каждого пользователя.</li>
</ol>
</section>
<section class="material__chapter">
<h2 id="7">Отладка с Postman</h2>
<p>Перед тем, как продолжить, нам надо убедиться, что созданный нами веб-сервер возвращает правильный ответ (или похожий на правильный). Воспользуемся для этого программой <a class="material__link" href="https://www.getpostman.com/" rel="noopener noreferrer" target="_blank">Postman</a>.</p>
<p>Postman — это приложение, которое позволяет взаимодействовать с API без написания кода. Это бывает удобно, чтобы находить ошибки и «пробовать» новое API перед разработкой. Postman не единственное подобное приложение, можете попробовать еще, например, <a class="material__link" href="https://insomnia.rest/" rel="noopener noreferrer" target="_blank">Insomnia</a>.</p>
<p>Сейчас мы проверим ответ от нашего приложения.</p>
<p>Запустите созданное ранее приложение в среде разработки и скопируйте адрес вида <code>http://127.0.0.1:5000/post</code> в строку запроса программы Postman.</p>
<p>JSON запроса можно взять из <a class="material__link" href="https://tech.yandex.ru/dialogs/alice/doc/protocol-docpage/" rel="noopener noreferrer" target="_blank">документации</a> Алисы или, на крайний случай, из рассмотренного нами примера.</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/postman-1.png" width="680"/></div>
<p>Проверьте, что ваш ответ похож на тот, что требует документация Алисы. Если это так, то поздравляем, мы добились результата :)</p>
<p>Для следующего шага нам понадобится, чтобы наш навык был доступен из Интернета, поэтому давайте либо задеплоим (разместим) его на Heroku, либо просто сделаем туннель с помощью ngrok.</p>
</section>
<section class="material__chapter">
<h2 id="8">Регистрация и тестирование навыка</h2>
<p>Перейдем к завершающему и самому простому пункту. Это регистрация навыка в Алисе.</p>
<ol>
<li>Зарегистрируйтесь в Яндексе или залогиньтесь, если вы уже зарегистрированы.</li>
<li>Перейдите по ссылке <a class="material__link" href="https://dialogs.yandex.ru/developer/" rel="noopener noreferrer" target="_blank">https://dialogs.yandex.ru/developer/</a>.</li>
<li>Нажмите <strong>создать диалог</strong>.</li>
<li>Выберите вариант <strong>Навык в Алисе</strong>.</li>
<li>Заполните «активационное имя». По этой фразе Алиса будет вызывать ваш навык.</li>
<li>Заполните поля, указав ссылку в поле Webhook URL.</li>
</ol>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/cabinet.png" width="680"/></div>
<p>Перейдите на вкладку <strong>Тестирование</strong> и проверьте работу своего навыка.</p>
</section>
<section class="material__chapter">
<h2 id="9">Именованные сущности</h2>
<p>Часто при создании навыка из ответа пользователя необходимо извлечь некоторую информацию, и не всегда это делается просто. Но разработчики Алисы уже позаботились о нас и сами выделяют некоторые такие сущности, которые в терминах Алисы называются <strong>именованными</strong>.</p>
<p>Под именованными сущностями подразумеваются:</p>
<ul>
<li>Имена</li>
<li>Фамилии</li>
<li>Названия городов и т. д.</li>
</ul>
<p>Когда пользователь в своем сообщении использует имя, фамилию или город, эти данные попадают в специальный раздел JSON’а, который отправляет нам Алиса.</p>
<p>Рассмотрим пример:</p>
<pre class="language-python"><code class="language-python"><span class="token punctuation">{</span>
  <span class="token string">"meta"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"locale"</span><span class="token punctuation">:</span> <span class="token string">"ru-RU"</span><span class="token punctuation">,</span>
    <span class="token string">"timezone"</span><span class="token punctuation">:</span> <span class="token string">"Europe/Moscow"</span><span class="token punctuation">,</span>
    <span class="token string">"client_id"</span><span class="token punctuation">:</span> <span class="token string">"ru.yandex.searchplugin/5.80 (Samsung Galaxy; Android 4.4)"</span><span class="token punctuation">,</span>
    <span class="token string">"interfaces"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"screen"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"request"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"command"</span><span class="token punctuation">:</span> <span class="token string">"закажи пиццу на улицу льва толстого, 16 на завтра"</span><span class="token punctuation">,</span>
    <span class="token string">"original_utterance"</span><span class="token punctuation">:</span> <span class="token string">"закажи пиццу на улицу льва толстого, 16 на завтра"</span><span class="token punctuation">,</span>
    <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"SimpleUtterance"</span><span class="token punctuation">,</span>
    <span class="token string">"markup"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"dangerous_context"</span><span class="token punctuation">:</span> true
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"payload"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"nlu"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"закажи"</span><span class="token punctuation">,</span>
        <span class="token string">"пиццу"</span><span class="token punctuation">,</span>
        <span class="token string">"на"</span><span class="token punctuation">,</span>
        <span class="token string">"льва"</span><span class="token punctuation">,</span>
        <span class="token string">"толстого"</span><span class="token punctuation">,</span>
        <span class="token string">"16"</span><span class="token punctuation">,</span>
        <span class="token string">"на"</span><span class="token punctuation">,</span>
        <span class="token string">"завтра"</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token string">"entities"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">6</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.GEO"</span><span class="token punctuation">,</span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"house_number"</span><span class="token punctuation">:</span> <span class="token string">"16"</span><span class="token punctuation">,</span>
            <span class="token string">"street"</span><span class="token punctuation">:</span> <span class="token string">"льва толстого"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.FIO"</span><span class="token punctuation">,</span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"first_name"</span><span class="token punctuation">:</span> <span class="token string">"лев"</span><span class="token punctuation">,</span>
            <span class="token string">"last_name"</span><span class="token punctuation">:</span> <span class="token string">"толстой"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">6</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.NUMBER"</span><span class="token punctuation">,</span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">16</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">8</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.DATETIME"</span><span class="token punctuation">,</span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"day"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"day_is_relative"</span><span class="token punctuation">:</span> true
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"session"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"new"</span><span class="token punctuation">:</span> true<span class="token punctuation">,</span>
    <span class="token string">"message_id"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token string">"session_id"</span><span class="token punctuation">:</span> <span class="token string">"2eac4854-fce721f3-b845abba-20d60"</span><span class="token punctuation">,</span>
    <span class="token string">"skill_id"</span><span class="token punctuation">:</span> <span class="token string">"3ad36498-f5rd-4079-a14b-788652932056"</span><span class="token punctuation">,</span>
    <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"AC9WC3DF6FCE052E45A4566A48E6B7193774B84814CE49A922E163B8B29881DC"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Обратите внимание на раздел request → nlu → tokens:</p>
<pre class="language-python"><code class="language-python"><span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token string">"закажи"</span><span class="token punctuation">,</span>
        <span class="token string">"пиццу"</span><span class="token punctuation">,</span>
        <span class="token string">"на"</span><span class="token punctuation">,</span>
        <span class="token string">"льва"</span><span class="token punctuation">,</span>
        <span class="token string">"толстого"</span><span class="token punctuation">,</span>
        <span class="token string">"16"</span><span class="token punctuation">,</span>
        <span class="token string">"на"</span><span class="token punctuation">,</span>
        <span class="token string">"завтра"</span>
      <span class="token punctuation">]</span>
</code></pre>
<p>Можно заметить, что это полученный от пользователя текст, разобранный на отдельные слова. Каждое слово при этом приводится к нижнему регистру. Это очень удобно, если надо искать вхождения каких-то определенных слов. Например, «да» или «нет».</p>
<p>Второй раздел, на который стоит обратить внимание — это entities (то есть <strong>сущности</strong>):</p>
<pre class="language-python"><code class="language-python"><span class="token string">"entities"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">6</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.GEO"</span><span class="token punctuation">,</span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"house_number"</span><span class="token punctuation">:</span> <span class="token string">"16"</span><span class="token punctuation">,</span>
            <span class="token string">"street"</span><span class="token punctuation">:</span> <span class="token string">"льва толстого"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">5</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.FIO"</span><span class="token punctuation">,</span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"first_name"</span><span class="token punctuation">:</span> <span class="token string">"лев"</span><span class="token punctuation">,</span>
            <span class="token string">"last_name"</span><span class="token punctuation">:</span> <span class="token string">"толстой"</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">6</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.NUMBER"</span><span class="token punctuation">,</span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token number">16</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">{</span>
          <span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">6</span><span class="token punctuation">,</span>
            <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">8</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.DATETIME"</span><span class="token punctuation">,</span>
          <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">"day"</span><span class="token punctuation">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
            <span class="token string">"day_is_relative"</span><span class="token punctuation">:</span> true
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">]</span>
</code></pre>
<p>Мы видим, что текст от пользователя подробно разобран и из него выделены все сущности от имени до даты.</p>
<p>entities — это массив таких сущностей. Рассмотрим одну сущность и подробно распишем, из чего же она состоит:</p>
<pre class="language-python"><code class="language-python"><span class="token punctuation">{</span>
<span class="token string">"tokens"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
   <span class="token string">"start"</span><span class="token punctuation">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
   <span class="token string">"end"</span><span class="token punctuation">:</span> <span class="token number">5</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
   <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"YANDEX.FIO"</span><span class="token punctuation">,</span>
   <span class="token string">"value"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"first_name"</span><span class="token punctuation">:</span> <span class="token string">"лев"</span><span class="token punctuation">,</span>
       <span class="token string">"last_name"</span><span class="token punctuation">:</span> <span class="token string">"толстой"</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li><var>tokens</var> — обозначение начала и конца именованной сущности в массиве слов (<var>tokens</var>, что мы рассматривали выше). Нумерация слов в массиве начинается с 0
<ul>
<li><var>start</var> — первое слово именованной сущности</li>
<li><var>end</var> — последнее слово после именованной сущности</li>
</ul>
</li>
<li><var>type</var> — тип именованной сущности. Возможные значения:
<ul>
<li>YANDEX.DATETIME — дата и время</li>
<li>YANDEX.FIO — фамилия, имя и отчество</li>
<li>YANDEX.GEO — местоположение (адрес или аэропорт)</li>
<li>YANDEX.NUMBER — число, целое или с плавающей точкой</li>
</ul>
</li>
<li><var>value</var> — формальное описание именованной сущности (мы приведем ниже пример для типа YANDEX.FIO. Описание остальных типов ищите в <a class="material__link" href="https://yandex.ru/dev/dialogs/alice/doc/naming-entities-docpage/" rel="noopener noreferrer" target="_blank">документации</a>)
<ul>
<li>first_name — имя</li>
<li>last_name — фамилия</li>
</ul>
</li>
</ul>
<p>Пример кода, получающий имя человека из JSON:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_first_name</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># перебираем сущности</span>
    <span class="token keyword">for</span> entity <span class="token keyword">in</span> req<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'nlu'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'entities'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># находим сущность с типом 'YANDEX.FIO'</span>
        <span class="token keyword">if</span> entity<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'YANDEX.FIO'</span><span class="token punctuation">:</span>
            <span class="token comment"># Если есть сущность с ключом 'first_name', </span>
            <span class="token comment"># возвращаем ее значение.</span>
            <span class="token comment"># Во всех остальных случаях возвращаем None.</span>
            <span class="token keyword">return</span> entity<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'first_name'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>
</code></pre>
</section>
<section class="material__chapter">
<h2 id="10">Ресурсы</h2>
<p>Для каждого навыка Алиса позволяет размещать до 100 MB дополнительных медиафайлов (изображения и звуки), но с некоторыми ограничениями:</p>
<ul>
<li>Изображение должно быть размером от 1 KB до 1 MB</li>
<li>Звуковой файл должен быть не длиннее 2-х минут</li>
</ul>
<p>Ресурсы можно добавить на вкладке «Ресурсы» в разделе управления навыком. Как работать с изображениями мы рассмотрим на следующем уроке, а пока давайте добавим какой-нибудь звук.</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/resources.png" width="680"/></div>
<p>После загрузки звукового файла добавится код его вставки в ответ. Чтобы добавить проигрывание звукового файла, надо добавить этот код в поле <var>tts</var> ответа.</p>
<p>Загружать ресурсы к навыку можно не только через веб-интерфейс, но и с помощью <a class="material__link" href="https://tech.yandex.ru/dialogs/alice/doc/resource-upload-docpage/" rel="noopener noreferrer" target="_blank">HTTP API Алисы</a>. Можно написать код с использованием библиотеки requests или воспользоваться Postman.</p>
<p>Идем по пунктам:</p>
<ol>
<li>Создадим новый навык. Зайдем на <a class="material__link" href="https://dialogs.yandex.ru/developer/" rel="noopener noreferrer" target="_blank">платформу диалогов</a> и нажмем <strong>создать новый навык</strong></li>
<li>Скопируем из URL и сохраним его идентификатор (ID):
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/zagruzkafoto.png" width="680"/></div>
</li>
<li>Получим token по <a class="material__link" href="https://oauth.yandex.ru/authorize?response_type=token&amp;client_id=c473ca268cd749d3a8371351a8f2bcbd" rel="noopener noreferrer" target="_blank">ссылке</a>. Сохраните его тоже. Он вам пригодится</li>
<li>Теперь запускаем Postman
<ul>
<li>Заполняем поля на вкладке Headers</li>
<li>Добавьте параметр с названием Authorization. Для этого в колонке KEY пишем Authorization, а в колонке VALUE — «OAuth Token» (OAuth пробел token, который вы получили)</li>
<li>В поле ссылки добавляем ссылку <code>https://dialogs.yandex.net/api/v1/skills/id_навыка/images</code> (заменить id_навыка на id из пункта 2) для изображения или <code>https://dialogs.yandex.net/api/v1/skills/id_навыка/sounds</code> для звукового файла</li>
</ul>
<img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/postman-2.png" width="680"/></li>
<li>Теперь на вкладке Body выбираем радио-кнопку form-data и добавляем файл. В колонке key напишите «file», в колонке value нажмите «choose file» и выберите файл с вашего компьютера. Далее нажимаем Send.</li>
</ol>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/postman-3.png" width="680"/></div>
<p>Если все сделано правильно, в ответе вы получите идентификатор картинки или звукового файла, который вы сможете использовать в дальнейшем.</p>
</section></article></section>