<section class="lesson-material__content"><article class="material"><h1>Алиса — урок 2</h1>
<section class="material__plan"><nav>
<ol>
<li><a class="material__link" href="#1">Введение</a></li>
<li><a class="material__link" href="#2">Картинка в ответе</a></li>
<li><a class="material__link" href="#3">Навык, который знакомится</a></li>
<li><a class="material__link" href="#4">Игра</a></li>
<li><a class="material__link" href="#5">Пользуемся API Яндекс.Карт</a></li>
<li><a class="material__link" href="#6">Получаем координаты города</a></li>
<li><a class="material__link" href="#7">Получаем страну города</a></li>
<li><a class="material__link" href="#8">Рассчитываем расстояние от города до города</a></li>
<li><a class="material__link" href="#9">Программируем навык</a></li>
<li><a class="material__link" href="#10">Функции Яндекс.Облака</a></li>
</ol>
</nav></section>
<section class="material__annotation">
<h2>Аннотация</h2>
<p>Сегодня мы продолжим разрабатывать навыки для Алисы: научим ее знакомиться с пользователем и взаимодействовать с внешними API. В качестве бонуса расскажем, как разместить свой навык в Яндекс.Облаке.</p>
</section>
<section class="material__chapter">
<h2 id="1">Введение</h2>
<p>На этом уроке мы напишем игру «Угадай город». Алиса показывает пользователю фотографию города, а он должен его отгадать.</p>
<p>Важный момент: перед игрой пользователь должен представиться, а Алиса — его поприветствовать. Это добавит нашему навыку немного человечности.</p>
<p>Находить именованные сущности (город и имя) мы уже умеем, осталось научиться отправлять пользователю картинку.</p>
<p>Итак, приступим.</p>
</section>
<section class="material__chapter">
<h2 id="2">Картинка в ответе</h2>
<p>Научимся показывать картинку в ответе. Например, для нашей игры нужно будет демонстрировать картинку города.</p>
<p>Для начала рассмотрим JSON ответа Алисы, в котором прикреплена картинка:</p>
<pre class="language-python"><code class="language-python"><span class="token punctuation">{</span>
  <span class="token string">"response"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"Здравствуйте! Это мы, хороводоведы."</span><span class="token punctuation">,</span>
    <span class="token string">"tts"</span><span class="token punctuation">:</span> <span class="token string">"Здравствуйте! Это мы, хоров+одо в+еды."</span><span class="token punctuation">,</span>
    <span class="token string">"card"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"BigImage"</span><span class="token punctuation">,</span>
      <span class="token string">"image_id"</span><span class="token punctuation">:</span> <span class="token string">"1027858/46r960da47f60207e924"</span><span class="token punctuation">,</span>
      <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Заголовок для изображения"</span><span class="token punctuation">,</span>
      <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Описание изображения."</span><span class="token punctuation">,</span>
      <span class="token string">"button"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"Надпись на кнопке"</span><span class="token punctuation">,</span>
        <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"http://example.com/"</span><span class="token punctuation">,</span>
        <span class="token string">"payload"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token string">"buttons"</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Надпись на кнопке"</span><span class="token punctuation">,</span>
        <span class="token string">"payload"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"https://example.com/"</span><span class="token punctuation">,</span>
        <span class="token string">"hide"</span><span class="token punctuation">:</span> true
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">"end_session"</span><span class="token punctuation">:</span> false
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"session"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">"session_id"</span><span class="token punctuation">:</span> <span class="token string">"2eac4854-fce721f3-b845abba-20d60"</span><span class="token punctuation">,</span>
    <span class="token string">"message_id"</span><span class="token punctuation">:</span> <span class="token number">4</span><span class="token punctuation">,</span>
    <span class="token string">"user_id"</span><span class="token punctuation">:</span> <span class="token string">"AC9WC3DF6FCE052E45A4566A48E6B7193774B84814CE49A922E163B8B29881DC"</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">"version"</span><span class="token punctuation">:</span> <span class="token string">"1.0"</span>
<span class="token punctuation">}</span>
</code></pre>
<p>В отличие от примера из предыдущего урока, в ответе появился раздел <var>card</var>. Он и содержит в себе картинку.</p>
<p>Рассмотрим подробно его содержание:</p>
<pre class="language-python"><code class="language-python"><span class="token string">"card"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">"type"</span><span class="token punctuation">:</span> <span class="token string">"BigImage"</span><span class="token punctuation">,</span>
      <span class="token string">"image_id"</span><span class="token punctuation">:</span> <span class="token string">"1027858/46r960da47f60207e924"</span><span class="token punctuation">,</span>
      <span class="token string">"title"</span><span class="token punctuation">:</span> <span class="token string">"Заголовок для изображения"</span><span class="token punctuation">,</span>
      <span class="token string">"description"</span><span class="token punctuation">:</span> <span class="token string">"Описание изображения."</span><span class="token punctuation">,</span>
      <span class="token string">"button"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
        <span class="token string">"text"</span><span class="token punctuation">:</span> <span class="token string">"Надпись на кнопке"</span><span class="token punctuation">,</span>
        <span class="token string">"url"</span><span class="token punctuation">:</span> <span class="token string">"http://example.com/"</span><span class="token punctuation">,</span>
        <span class="token string">"payload"</span><span class="token punctuation">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
</code></pre>
<p>Мы опишем только те поля, которые будем использовать. Про оставшиеся можно посмотреть в <a class="material__link" href="https://tech.yandex.ru/dialogs/alice/doc/protocol-docpage/#response" rel="noopener noreferrer" target="_blank">документации Алисы</a>.</p>
<p><var>card</var> — описание карточки-сообщения с поддержкой изображений. Если приложению удается отобразить карточку для пользователя, свойство <var>response.text</var> не используется</p>
<ul>
<li><var>type</var> — тип карточки. Поддерживаемые значения:
<ul>
<li><var>BigImage</var> — одно изображение</li>
<li><var>ItemsList</var> — галерея изображений (от 1 до 5)</li>
Требуемый формат ответа зависит от типа карточки. Мы будем использовать BigImage</ul>
</li>
<li><var>image_id</var> — идентификатор изображения, который возвращается в ответ на запрос загрузки</li>
<li><var>title</var> — заголовок для изображения. Это на самом деле увидит пользователь</li>
</ul>
<p>В этом <a class="material__link" href="https://yastatic.net/s3/lyceum/content/resources/cities.zip" rel="noopener noreferrer" target="_blank">архиве</a> мы собрали для вас картинки, которые можно использовать для решения задач урока (но можете использовать свои изображения). Подробно про то, как загружать ресурсы к своему навыку, мы говорили на прошлом уроке.</p>
<p>Вот как может выглядеть ответ Алисы с картинкой:</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/alice-with-image.png" width="680"/></div>
</section>
<section class="material__chapter">
<h2 id="3">Навык, который знакомится</h2>
<p>Напишем простой навык, который ведет следующий диалог:</p>
<ul>
<li>Привет! Назови свое имя!</li>
<li>Саша.</li>
<li>Приятно познакомиться, Саша. Я — Алиса. Какой город хочешь увидеть?</li>
<li>Москва (Нью-йорк, Париж).</li>
<li>Этот город я знаю. <em>И показывает фото города</em></li>
</ul>
<p>Если вдруг пользователь не назвал имя, Алиса должна сказать:</p>
<ul>
<li>Не расслышала имя. Повтори, пожалуйста!</li>
</ul>
<p>Если пользователь не назвал город или назвал город, для которого нет картинки, Алиса должна сказать:</p>
<ul>
<li>Первый раз слышу об этом городе. Попробуй еще разок!</li>
</ul>
<p>Код приведен ниже:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> json
<span class="token keyword">import</span> random

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">)</span>

<span class="token comment"># создаем словарь, в котором ключ — название города,</span>
<span class="token comment"># а значение — массив, где перечислены id картинок,</span>
<span class="token comment"># которые мы записали в прошлом пункте.</span>

cities <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token string">'москва'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'1540737/daa6e420d33102bf6947'</span><span class="token punctuation">,</span>
               <span class="token string">'213044/7df73ae4cc715175059e'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'нью-йорк'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">'1652229/728d5c86707054d4745f'</span><span class="token punctuation">,</span>
                 <span class="token string">'1030494/aca7ed7acefde2606bdc'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token string">'париж'</span><span class="token punctuation">:</span> <span class="token punctuation">[</span><span class="token string">"1652229/f77136c2364eb90a3ea8"</span><span class="token punctuation">,</span>
              <span class="token string">'3450494/aca7ed7acefde22341bdc'</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment"># создаем словарь, где для каждого пользователя</span>
<span class="token comment"># мы будем хранить его имя</span>
sessionStorage <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>


@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Request: </span><span class="token interpolation"><span class="token punctuation">{</span>request<span class="token punctuation">.</span>json<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'session'</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'version'</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'version'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'response'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'end_session'</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    handle_dialog<span class="token punctuation">(</span>response<span class="token punctuation">,</span> request<span class="token punctuation">.</span>json<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string-interpolation"><span class="token string">f'Response: </span><span class="token interpolation"><span class="token punctuation">{</span>response<span class="token conversion-option punctuation">!r</span><span class="token punctuation">}</span></span><span class="token string">'</span></span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>response<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">handle_dialog</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_id <span class="token operator">=</span> req<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span>

    <span class="token comment"># если пользователь новый, то просим его представиться.</span>
    <span class="token keyword">if</span> req<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Привет! Назови свое имя!'</span>
        <span class="token comment"># создаем словарь в который в будущем положим имя пользователя</span>
        sessionStorage<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">'first_name'</span><span class="token punctuation">:</span> <span class="token boolean">None</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span>

    <span class="token comment"># если пользователь не новый, то попадаем сюда.</span>
    <span class="token comment"># если поле имени пустое, то это говорит о том,</span>
    <span class="token comment"># что пользователь еще не представился.</span>
    <span class="token keyword">if</span> sessionStorage<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'first_name'</span><span class="token punctuation">]</span> <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
        <span class="token comment"># в последнем его сообщение ищем имя.</span>
        first_name <span class="token operator">=</span> get_first_name<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token comment"># если не нашли, то сообщаем пользователю что не расслышали.</span>
        <span class="token keyword">if</span> first_name <span class="token keyword">is</span> <span class="token boolean">None</span><span class="token punctuation">:</span>
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> \
                <span class="token string">'Не расслышала имя. Повтори, пожалуйста!'</span>
        <span class="token comment"># если нашли, то приветствуем пользователя.</span>
        <span class="token comment"># И спрашиваем какой город он хочет увидеть.</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            sessionStorage<span class="token punctuation">[</span>user_id<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'first_name'</span><span class="token punctuation">]</span> <span class="token operator">=</span> first_name
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>
                <span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Приятно познакомиться, '</span> \
                          <span class="token operator">+</span> first_name<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span> \
                          <span class="token operator">+</span> <span class="token string">'. Я - Алиса. Какой город хочешь увидеть?'</span>
            <span class="token comment"># получаем варианты buttons из ключей нашего словаря cities</span>
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'buttons'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">[</span>
                <span class="token punctuation">{</span>
                    <span class="token string">'title'</span><span class="token punctuation">:</span> city<span class="token punctuation">.</span>title<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                    <span class="token string">'hide'</span><span class="token punctuation">:</span> <span class="token boolean">True</span>
                <span class="token punctuation">}</span> <span class="token keyword">for</span> city <span class="token keyword">in</span> cities
            <span class="token punctuation">]</span>
    <span class="token comment"># если мы знакомы с пользователем и он нам что-то написал,</span>
    <span class="token comment"># то это говорит о том, что он уже говорит о городе,</span>
    <span class="token comment"># что хочет увидеть.</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        <span class="token comment"># ищем город в сообщение от пользователя</span>
        city <span class="token operator">=</span> get_city<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
        <span class="token comment"># если этот город среди известных нам,</span>
        <span class="token comment"># то показываем его (выбираем одну из двух картинок случайно)</span>
        <span class="token keyword">if</span> city <span class="token keyword">in</span> cities<span class="token punctuation">:</span>
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'card'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'card'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'BigImage'</span>
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'card'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'title'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Этот город я знаю.'</span>
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'card'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'image_id'</span><span class="token punctuation">]</span> <span class="token operator">=</span> random<span class="token punctuation">.</span>choice<span class="token punctuation">(</span>cities<span class="token punctuation">[</span>city<span class="token punctuation">]</span><span class="token punctuation">)</span>
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Я угадал!'</span>
        <span class="token comment"># если не нашел, то отвечает пользователю</span>
        <span class="token comment"># 'Первый раз слышу об этом городе.'</span>
        <span class="token keyword">else</span><span class="token punctuation">:</span>
            res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> \
                <span class="token string">'Первый раз слышу об этом городе. Попробуй еще разок!'</span>


<span class="token keyword">def</span> <span class="token function">get_city</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># перебираем именованные сущности</span>
    <span class="token keyword">for</span> entity <span class="token keyword">in</span> req<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'nlu'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'entities'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># если тип YANDEX.GEO то пытаемся получить город(city),</span>
        <span class="token comment"># если нет, то возвращаем None</span>
        <span class="token keyword">if</span> entity<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'YANDEX.GEO'</span><span class="token punctuation">:</span>
            <span class="token comment"># возвращаем None, если не нашли сущности с типом YANDEX.GEO</span>
            <span class="token keyword">return</span> entity<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'city'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">get_first_name</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># перебираем сущности</span>
    <span class="token keyword">for</span> entity <span class="token keyword">in</span> req<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'nlu'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'entities'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token comment"># находим сущность с типом 'YANDEX.FIO'</span>
        <span class="token keyword">if</span> entity<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'YANDEX.FIO'</span><span class="token punctuation">:</span>
            <span class="token comment"># Если есть сущность с ключом 'first_name',</span>
            <span class="token comment"># то возвращаем ее значение.</span>
            <span class="token comment"># Во всех остальных случаях возвращаем None.</span>
            <span class="token keyword">return</span> entity<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>get<span class="token punctuation">(</span><span class="token string">'first_name'</span><span class="token punctuation">,</span> <span class="token boolean">None</span><span class="token punctuation">)</span>


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Загружаем этот код в Heroku или делаем туннель в ngrok, заполняем данные в Алисе и отправляемся тестировать!</p>
</section>
<section class="material__chapter">
<h2 id="4">Игра</h2>
<p>Доработаем предыдущую программу до конца.</p>
<p>Рассмотрим блок-схему, чтобы понять логику общения нашего навыка с пользователем.</p>
<div class="material__content-positioner"><img class="material__illustration" height="auto" src="https://yastatic.net/s3/lyceum/content/image/alice-2-4.png" width="680"/></div>
<p>Код игры приведен в <a class="material__link" href="https://yastatic.net/s3/lyceum/content/resources/alice-2-game.py" rel="noopener noreferrer" target="_blank">файле</a>.</p>
</section>
<section class="material__chapter">
<h2 id="5">Пользуемся API Яндекс.Карт</h2>
<p>Сегодня мы попробуем совместить наш опыт по работе со сторонними API (Яндекс.Карты) и знания Алисы, чтобы создать новый навык, который будет сообщать пользователю, в какой стране находится загаданный город, а также вычислять расстояние от одного города до другого.</p>
<p>Алгоритм работы навыка следующий:</p>
<ul>
<li>Если мы пишем название одного города, Алиса сообщит нам, в какой стране находится этот город</li>
<li>Если мы пишем названия двух городов, Алиса посчитает расстояние между ними</li>
<li>Если мы вдруг напишем названия трех и более городов, Алиса возмутится и сообщит: «Слишком много городов. Я запуталась»</li>
</ul>
<p>Для получения информации о географических объектах мы воспользуемся <a class="material__link" href="https://tech.yandex.ru/maps/geocoder/" rel="noopener noreferrer" target="_blank">геокодером Яндекс.Карт</a>.</p>
</section>
<section class="material__chapter">
<h2 id="6">Получаем координаты города</h2>
<p>Мы уже знаем, что Алиса умеет вычленять из текста разные сущности, в том числе и названия городов.</p>
<p>Напишем функцию <code>get_coordinates(city_name)</code>, которая получает географические координаты города по его имени.</p>
<p>Напомним: надо отправить <strong>HTTP-запрос</strong>, например, такой <code>https://geocode-maps.yandex.ru/1.x/?geocode=Москва&amp;format=json</code> Яндекс.Картам, а потом разобрать ответ.</p>
<p>Возвращает эта функция кортеж с координатами города. В случае, если в процессе работы произошла <strong>любая ошибка</strong>, мы вернем исключение.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> requests


<span class="token keyword">def</span> <span class="token function">get_coordinates</span><span class="token punctuation">(</span>city_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        <span class="token comment"># url, по которому доступно API Яндекс.Карт</span>
        url <span class="token operator">=</span> <span class="token string">"https://geocode-maps.yandex.ru/1.x/"</span>
        <span class="token comment"># параметры запроса</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"apikey"</span><span class="token punctuation">:</span> <span class="token string">"40d1649f-0493-4b70-98ba-98533de7710b"</span><span class="token punctuation">,</span>
            <span class="token comment"># город, координаты которого мы ищем</span>
            <span class="token string">'geocode'</span><span class="token punctuation">:</span> city_name<span class="token punctuation">,</span>
            <span class="token comment"># формат ответа от сервера, в данном случае JSON</span>
            <span class="token string">'format'</span><span class="token punctuation">:</span> <span class="token string">'json'</span>
        <span class="token punctuation">}</span>
        <span class="token comment"># отправляем запрос</span>
        response <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token punctuation">)</span>
        <span class="token comment"># получаем JSON ответа</span>
        json <span class="token operator">=</span> response<span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># получаем координаты города</span>
        <span class="token comment"># (там написаны долгота(longitude), широта(latitude) через пробел)</span>
        <span class="token comment"># посмотреть подробное описание JSON-ответа можно</span>
        <span class="token comment"># в документации по адресу https://tech.yandex.ru/maps/geocoder/</span>
        coordinates_str <span class="token operator">=</span> json<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'GeoObjectCollection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>
            <span class="token string">'featureMember'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'GeoObject'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Point'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'pos'</span><span class="token punctuation">]</span>
        <span class="token comment"># Превращаем string в список, так как</span>
        <span class="token comment"># точка - это пара двух чисел - координат</span>
        <span class="token builtin">long</span><span class="token punctuation">,</span> lat <span class="token operator">=</span> <span class="token builtin">map</span><span class="token punctuation">(</span><span class="token builtin">float</span><span class="token punctuation">,</span> coordinates_str<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment"># Вернем ответ</span>
        <span class="token keyword">return</span> <span class="token builtin">long</span><span class="token punctuation">,</span> lat
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> e
</code></pre>
</section>
<section class="material__chapter">
<h2 id="7">Получаем страну города</h2>
<p>Функция <code>get_country(city_name)</code> вернет нам страну, в которой находится указанный город. Отличие от предыдущей функции заключается лишь в получении других данных из ответа геокодера.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">get_country</span><span class="token punctuation">(</span>city_name<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token keyword">try</span><span class="token punctuation">:</span>
        url <span class="token operator">=</span> <span class="token string">"https://geocode-maps.yandex.ru/1.x/"</span>
        params <span class="token operator">=</span> <span class="token punctuation">{</span>
            <span class="token string">"apikey"</span><span class="token punctuation">:</span> <span class="token string">"40d1649f-0493-4b70-98ba-98533de7710b"</span><span class="token punctuation">,</span>
            <span class="token string">'geocode'</span><span class="token punctuation">:</span> city_name<span class="token punctuation">,</span>
            <span class="token string">'format'</span><span class="token punctuation">:</span> <span class="token string">'json'</span>
        <span class="token punctuation">}</span>
        data <span class="token operator">=</span> requests<span class="token punctuation">.</span>get<span class="token punctuation">(</span>url<span class="token punctuation">,</span> params<span class="token punctuation">)</span><span class="token punctuation">.</span>json<span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token comment"># все отличие тут, мы получаем имя страны</span>
        <span class="token keyword">return</span> data<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'GeoObjectCollection'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>
            <span class="token string">'featureMember'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'GeoObject'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'metaDataProperty'</span><span class="token punctuation">]</span><span class="token punctuation">[</span>
            <span class="token string">'GeocoderMetaData'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'AddressDetails'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'Country'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'CountryName'</span><span class="token punctuation">]</span>
    <span class="token keyword">except</span> Exception <span class="token keyword">as</span> e<span class="token punctuation">:</span>
        <span class="token keyword">return</span> e
</code></pre>
</section>
<section class="material__chapter">
<h2 id="8">Рассчитываем расстояние от города до города</h2>
<p>А вот для вычисления расстояний между двумя точками необходимы знания <strong>тригонометрических</strong> функций. Ведь Земля — круглая!</p>
<p>Подробно о расчете коротких расстояний на Земле можно прочитать <a class="material__link" href="https://en.wikipedia.org/wiki/Haversine_formula" rel="noopener noreferrer" target="_blank">тут</a>. Пока же можно просто воспользоваться приведенной функцией.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">import</span> math


<span class="token keyword">def</span> <span class="token function">get_distance</span><span class="token punctuation">(</span>p1<span class="token punctuation">,</span> p2<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token comment"># p1 и p2 - это кортежи из двух элементов - координаты точек</span>
    radius <span class="token operator">=</span> <span class="token number">6373.0</span>

    lon1 <span class="token operator">=</span> math<span class="token punctuation">.</span>radians<span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    lat1 <span class="token operator">=</span> math<span class="token punctuation">.</span>radians<span class="token punctuation">(</span>p1<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    lon2 <span class="token operator">=</span> math<span class="token punctuation">.</span>radians<span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    lat2 <span class="token operator">=</span> math<span class="token punctuation">.</span>radians<span class="token punctuation">(</span>p2<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span>

    d_lon <span class="token operator">=</span> lon2 <span class="token operator">-</span> lon1
    d_lat <span class="token operator">=</span> lat2 <span class="token operator">-</span> lat1

    a <span class="token operator">=</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>d_lat <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span> <span class="token operator">+</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>lat1<span class="token punctuation">)</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>cos<span class="token punctuation">(</span>lat2<span class="token punctuation">)</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>sin<span class="token punctuation">(</span>d_lon <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">2</span>
    c <span class="token operator">=</span> <span class="token number">2</span> <span class="token operator">*</span> math<span class="token punctuation">.</span>atan2<span class="token punctuation">(</span>a <span class="token operator">**</span> <span class="token number">0.5</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token number">1</span> <span class="token operator">-</span> a<span class="token punctuation">)</span> <span class="token operator">**</span> <span class="token number">0.5</span><span class="token punctuation">)</span>

    distance <span class="token operator">=</span> radius <span class="token operator">*</span> c
    <span class="token keyword">return</span> distance
</code></pre>
</section>
<section class="material__chapter">
<h2 id="9">Программируем навык</h2>
<p>Наша программа будет состоять из двух файлов.</p>
<p>В первом файле мы разместим код, который будет отвечать за общение с Алисой, а во втором — функции, которые связаны с общением с API Яндекс.Карт.</p>
<p>Всю функциональность общения с картами мы уже реализовали, поэтому осталось объединить все функции в один файл — <a class="material__link" href="https://yastatic.net/s3/lyceum/content/resources/geo.py" rel="noopener noreferrer" target="_blank">geo.py</a>.</p>
<p>А во втором файле мы расположим код, который отвечает за общение с Алисой — <a class="material__link" href="https://yastatic.net/s3/lyceum/content/resources/app.py" rel="noopener noreferrer" target="_blank">app.py</a>.</p>
<p>Многое из того, что мы делаем тут, уже было сделано в других уроках. Так что объясним только новые моменты.</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">from</span> flask <span class="token keyword">import</span> Flask<span class="token punctuation">,</span> request
<span class="token keyword">import</span> logging
<span class="token keyword">import</span> json
<span class="token comment"># импортируем функции из нашего второго файла geo</span>
<span class="token keyword">from</span> geo <span class="token keyword">import</span> get_country<span class="token punctuation">,</span> get_distance<span class="token punctuation">,</span> get_coordinates

app <span class="token operator">=</span> Flask<span class="token punctuation">(</span>__name__<span class="token punctuation">)</span>

<span class="token comment"># Добавляем логирование в файл. </span>
<span class="token comment"># Чтобы найти файл, перейдите на pythonwhere в раздел files, </span>
<span class="token comment"># он лежит в корневой папке</span>
logging<span class="token punctuation">.</span>basicConfig<span class="token punctuation">(</span>level<span class="token operator">=</span>logging<span class="token punctuation">.</span>INFO<span class="token punctuation">,</span> filename<span class="token operator">=</span><span class="token string">'app.log'</span><span class="token punctuation">,</span>
                    <span class="token builtin">format</span><span class="token operator">=</span><span class="token string">'%(asctime)s %(levelname)s %(name)s %(message)s'</span><span class="token punctuation">)</span>


@app<span class="token punctuation">.</span>route<span class="token punctuation">(</span><span class="token string">'/post'</span><span class="token punctuation">,</span> methods<span class="token operator">=</span><span class="token punctuation">[</span><span class="token string">'POST'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token keyword">def</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">:</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Request: %r'</span><span class="token punctuation">,</span> request<span class="token punctuation">.</span>json<span class="token punctuation">)</span>
    response <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token string">'session'</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'version'</span><span class="token punctuation">:</span> request<span class="token punctuation">.</span>json<span class="token punctuation">[</span><span class="token string">'version'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'response'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'end_session'</span><span class="token punctuation">:</span> <span class="token boolean">False</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    handle_dialog<span class="token punctuation">(</span>response<span class="token punctuation">,</span> request<span class="token punctuation">.</span>json<span class="token punctuation">)</span>
    logging<span class="token punctuation">.</span>info<span class="token punctuation">(</span><span class="token string">'Request: %r'</span><span class="token punctuation">,</span> response<span class="token punctuation">)</span>
    <span class="token keyword">return</span> json<span class="token punctuation">.</span>dumps<span class="token punctuation">(</span>response<span class="token punctuation">)</span>


<span class="token keyword">def</span> <span class="token function">handle_dialog</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> req<span class="token punctuation">)</span><span class="token punctuation">:</span>
    user_id <span class="token operator">=</span> req<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'user_id'</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> req<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'new'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> \
            <span class="token string">'Привет! Я могу показать город или сказать расстояние между городами!'</span>
        <span class="token keyword">return</span>
    <span class="token comment"># Получаем города из нашего</span>
    cities <span class="token operator">=</span> get_cities<span class="token punctuation">(</span>req<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token keyword">not</span> cities<span class="token punctuation">:</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Ты не написал название не одного города!'</span>
    <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cities<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">:</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Этот город в стране - '</span> <span class="token operator">+</span> \
                                  get_country<span class="token punctuation">(</span>cities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">elif</span> <span class="token builtin">len</span><span class="token punctuation">(</span>cities<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">:</span>
        distance <span class="token operator">=</span> get_distance<span class="token punctuation">(</span>get_coordinates<span class="token punctuation">(</span>
            cities<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">,</span> get_coordinates<span class="token punctuation">(</span>cities<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Расстояние между этими городами: '</span> <span class="token operator">+</span> \
                                  <span class="token builtin">str</span><span class="token punctuation">(</span><span class="token builtin">round</span><span class="token punctuation">(</span>distance<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">' км.'</span>
    <span class="token keyword">else</span><span class="token punctuation">:</span>
        res<span class="token punctuation">[</span><span class="token string">'response'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'text'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'Слишком много городов!'</span>


<span class="token keyword">def</span> <span class="token function">get_cities</span><span class="token punctuation">(</span>req<span class="token punctuation">)</span><span class="token punctuation">:</span>
    cities <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">for</span> entity <span class="token keyword">in</span> req<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'nlu'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'entities'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
        <span class="token keyword">if</span> entity<span class="token punctuation">[</span><span class="token string">'type'</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">'YANDEX.GEO'</span><span class="token punctuation">:</span>
            <span class="token keyword">if</span> <span class="token string">'city'</span> <span class="token keyword">in</span> entity<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">:</span>
                cities<span class="token punctuation">.</span>append<span class="token punctuation">(</span>entity<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'city'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> cities


<span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>
    app<span class="token punctuation">.</span>run<span class="token punctuation">(</span><span class="token punctuation">)</span>
</code></pre>
<p>Осталось протестировать и задеплоить наш навык.</p>
</section>
<section class="material__chapter">
<h2 id="10">Функции Яндекс.Облака</h2>
<p>Яндекс.Облако добавило возможность создавать свои функции в облаке без необходимости настраивать виртуальную машину и различные права доступа. У функций ограниченная функциональность, но вполне достаточная для, например, небольших навыков для голосового помощника Алиса. Большим плюсом использования функций с этой целью является то, что в этом случае они <strong>не тарифицируются</strong>, то есть пользователь может размещать сколько угодно таких функций бесплатно.</p>
<p>Давайте посмотрим, как сделать свою функцию. Зайдем в Яндекс.Облако и выберем пункт меню Cloud Functions.</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/alice-cloud-1.png" width="349"/></div>
<p>Мы рассмотрим пример создания функции для самого простого навыка, который просто повторяет пользовательский ввод. Поэтому введем название и описание навыка исходя из его функциональности:</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/alice-cloud-2.png" width="680"/></div>
<p>После этого создадим функцию. Файл можно создать как в редакторе, так и сделать его на своем компьютере, а потом загрузить в облако zip-архив.</p>
<p>Сама функция будет немного отличаться от того кода, который мы привыкли делать с использованием flask. Вот пример кода файла main.py:</p>
<pre class="language-python"><code class="language-python"><span class="token keyword">def</span> <span class="token function">handler</span><span class="token punctuation">(</span>event<span class="token punctuation">,</span> context<span class="token punctuation">)</span><span class="token punctuation">:</span>
    <span class="token triple-quoted-string string">"""
    Точка входа для облачной функции.
    :param event: содержимое request.json().
    :param context: информация о текущем контексте выполнения.
    :return: ответ будет представлен в виде json автоматически.
    """</span>
    text <span class="token operator">=</span> <span class="token string">'Привет, я повторю все, что вы скажете'</span>
    <span class="token keyword">if</span> <span class="token string">'request'</span> <span class="token keyword">in</span> event <span class="token keyword">and</span> \
            <span class="token string">'original_utterance'</span> <span class="token keyword">in</span> event<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span> \
            <span class="token keyword">and</span> <span class="token builtin">len</span><span class="token punctuation">(</span>event<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'original_utterance'</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">:</span>
        text <span class="token operator">=</span> event<span class="token punctuation">[</span><span class="token string">'request'</span><span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">'original_utterance'</span><span class="token punctuation">]</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
        <span class="token string">'version'</span><span class="token punctuation">:</span> event<span class="token punctuation">[</span><span class="token string">'version'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'session'</span><span class="token punctuation">:</span> event<span class="token punctuation">[</span><span class="token string">'session'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token string">'response'</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
            <span class="token string">'text'</span><span class="token punctuation">:</span> text<span class="token punctuation">,</span>
            <span class="token string">'end_session'</span><span class="token punctuation">:</span> <span class="token string">'false'</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
</code></pre>
<p>Обратите внимание: flask тут нам уже не нужен. Мы просто делаем функцию с определенной сигнатурой. Запрос к ней обработает Яндекс.Облако и положит все, что было, в <code>request.json()</code> в параметр <var>event</var>. Кроме того, нет необходимости самостоятельно формировать json в ответ, это произойдет автоматически.</p>
<p>Для того чтобы наша функция работала корректно, надо указать еще следующие значения в настройках:</p>
<ul>
<li>Среда выполнения — python37</li>
<li>Точка входа — main.handler (имя файла без py + имя функции в этом файле, которую надо запускать)</li>
</ul>
<p>После этого можно нажать кнопку «Создать версию».</p>
<p>На вкладке «Тестирование» можно отправить тестовый запрос в нашу функцию почти как в Postman, причем есть возможность указать шаблон данных в формате запроса Алисы.</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/alice-cloud-3.png" width="680"/></div>
<p>Протестируйте функцию.</p>
<p>Для того чтобы Алиса смогла отправить запрос к функции, ее надо сделать <strong>публичной</strong>. Этот переключатель находится на вкладке <strong>Обзор</strong>. Ссылку для Алисы копировать необязательно.</p>
<p>Теперь перейдем в настройки навыка Алисы и вместо Webhook выберем нужную публичную функцию в Яндекс.Облаке из списка:</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/alice-cloud-4.png" width="680"/></div>
<p>Убедимся, что все работает:</p>
<div class="material__content-positioner"><img class="material__illustration material__screenshot" height="auto" src="https://yastatic.net/s3/lyceum/content/images/second-year/alice/alice-cloud-5.png" width="680"/></div>
<p>То, что функция не использует flask, немного неудобно для локальной отладки. Но достаточно просто вынести ее в отдельный файл так, чтобы обработчик URL из flask вызывал ее, подстраивая данные до нужной сигнатуры и затем превращая ответ в json. Таким образом будет удобно и локально тестировать функцию, и затем заливать ее в Яндекс.Облако.</p>
</section></article></section>